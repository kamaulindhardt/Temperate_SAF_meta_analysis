---
title: "2_generating_visualisations"
author: "Kamau Lindhardt, lbk125"
date: "26/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Aim & Research questions

The **aim** of this systematic mapping review is to thoroughly catalogue and assess the current research themes of knowledge abundance and scarcity and provide the first global systematic synthesis of ES research in relation to temperate SAF. We specifically addressed the following four **research questions**:

1.  What temperate SAF systems and ecosystem services have been studied?

2.  What tree and crop species composition and associations are used in temperate
    SAF systems?

3.  How are temperate SAF systems and ecosystem services distributed
    across geographic and biophysical gradients?

4.  To what extend does biophysical properties, such as soil quality, temperature and precipitation drive inter-site differences?Â 

Descriptive statistics, e.g. frequency of occurrences is used to visualise data

# Preparing R script

Packages to be installed first

```{r Installing the pacman package, warning=FALSE}
# install.packages("pacman")

# install.packages("pacman")
# install.packages("tidygeocoder")
# install.packages("ggdensity")
# install.packages("rnaturalearth")
# install.packages("rnaturalearthdata")
# install.packages("gridExtra")
# install.packages("soilDB")
# install.packages("aqp")
# install.packages("geodata")
```

Loading packages and libraries

```{r Loading other needed packages, warning=FALSE}
suppressWarnings({

  # Applying the p_load function to load multiple add-on packages in one line of code.

  pacman::p_load(
    tidyverse,
    readxl,
    vroom, # for crazy fast method of loading/reading datasets from local disc
    janitor, # for cleaning data column names
    ggplot2,
    ggdensity, # for making great plots, e.g. ridgeline
    gridExtra, # for making multiplots
    ggrepel, # for making text lables next to ggplots
    ggpubr,
    ggthemes,
    ggsci,
    wesanderson, # for colour palettes
    colorspace, # for colour palettes
    gt, # for beautiful tables
    DT,
    cowplot, # for making multi-plots side by side
    patchwork, # for making multi-plots side by side
    lubridate, # for making time-scale analysis (e.g. publications per year)
    scales,
    zoo,
    ggridges, # for making nice ridgeline plots
    gitcreds, # for GitHub syncronisation
    flextable, # for exporting nice lokking tables from R in ".png"
    #styler, # for neatly organising code
  ) 
})
```

Update GitHub credentials for efficient 'push' and 'pull' operations

```{r Update GitHub credentials for efficient 'push' and 'pull' operations}
# Run this function in order to update GitHub credentials for efficient 'push' and 'pull' operations

# gitcreds_set()
```

Loading main database

```{r Loading database 2.0, warning=FALSE, message=FALSE}
suppressWarnings({ 
  
database <- read_excel("DATA/DATABASE_2.0.xlsx", 
    sheet = "MAIN_DATABASE_2.0") %>%
    filter(INCLUDED == TRUE)

})
```

Glimpse (taking a look at the data)

```{r Glimpse the dataset, eval=FALSE}
database %>% dplyr::glimpse() 
```

Defining number of independent studies and number of observations based on individual study sites

```{r Number of studies and study sites}
n_independent_studies <- database %>%
  distinct(ID.P) %>%
  nrow()

# n_independent_studies = 73 (16 aug. 2022)

n_individual_study_sites <- database %>%
  distinct(ID.P, ID.S) %>%
  nrow()

# n_individual_study_sites = 213 (16 aug. 2022)
```

Colour and design elements

```{r Colours and colour palettes}
# scales::show_col(ipsum_pal()(9))

# Define colour palette for a single colors
my_col_single = sequential_hcl(1, palette = "Terrain 2")

my_cols_pal_four <-  qualitative_hcl(4, palette = "Dynamic")
#wes_palette("Zissou1", 4, type = "continuous")

my_cols_pal_six <- qualitative_hcl(6, palette = "Dynamic")
#wes_palette("Zissou1", 6, type = "continuous")

my_cols_pal_8 <- qualitative_hcl(8, palette = "Dynamic")

my_cols_pal_7 <- qualitative_hcl(7, palette = "Dynamic")

my_cols_pal_32 <- qualitative_hcl(32, palette = "Dynamic")

my_cols_pal_100 <- diverging_hcl(100, palette = "Green-Orange")
#wes_palette("Zissou1", 100, type = "continuous")

```

Function that sets the size of the figure margins

```{r Figure margin size function}
# Writing a small function that sets the size of the margin based on the number of characters in the leftmost x-axis category value.
# the function makes use of the number of characters in the dataset$column and adds an additional number of space based on what is specified in the function

margin_spacer <- function(x) {
  # where x is the column in your dataset
  left_length <- nchar(levels(factor(x)))[1]
  if (left_length > 8) {
    return((left_length - 8) * 10) # additional figure margin space is here set to 10, if the x-axis category is having > 8 characters.
  } else {
    return(0)
  }
}
```

# Structure of this script is as follows:

1.  Single variate data dimensions are visualised (everything that is not matrices)

2.  Multivariate data dimensions are visualised (mostly matrices)

3.  Geospatially-related data dimensions (biophysical data) are visualised

# Visualising single variate datasets

**Publications per year**

```{r Publications per year}
# -----------------------------------------------------------------------------------------------------------
# preparing dataset
pub.year.data <-
  database %>%
  filter(INCLUDED == TRUE) %>%
  dplyr::select(ID.P, PUB.YR) %>%
  mutate_if(is.character, as.numeric) %>%
  distinct(ID.P, PUB.YR) %>%
  group_by(PUB.YR) %>%
  summarise(no_studies = n()) %>%
  mutate(no_studies_accum = cumsum(no_studies)) %>%
  # cumulative number of studies over time
  arrange(desc(-PUB.YR)) %>%
  mutate_if(is.integer, as.numeric)
# add_tally() %>%

# -----------------------------------------------------------------------------------------------------------
# adding date-time scales by transforming the year column into a POSIXct class
pub.year.data$yeardate <- as.POSIXct(as.yearmon(pub.year.data$PUB.YR, format = "%Y%"))

# -----------------------------------------------------------------------------------------------------------
# generating plot
pub.year.plot <-
  labs(
    title = "Accumulated peer-reviewed publications over time",
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    y = "Accumulated number of publications"
  )
```

**Bar plot; accumulated number of studies over the years**

```{r PLOTTING - accumulated number of studies over the years}
pub.year.plot <-
  pub.year.data %>%
  ggplot() +
  geom_col(aes(x = PUB.YR, y = no_studies, alpha = 0.9), fill = my_col_single) +
  geom_step(aes(x = PUB.YR, y = no_studies_accum, alpha = 0.9), size = 0.5, col = "black") +
  theme_bw() +
  scale_x_continuous(breaks = pretty(pub.year.data$PUB.YR, n = 25), minor_breaks = 1, limits = c(1990, 2025)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(
    title = "Accumulated peer-reviewed publications over time",
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    y = "Accumulated number of publications"
  )

pub.year.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "pub.year.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 30, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

**Publications per Journal**

```{r}
# preparing dataset
pub.jounal.data <-
  database %>%
  filter(INCLUDED == TRUE) %>%
  dplyr::select(ID.P, JOURNAL) %>%
  mutate_if(is.character, as.factor) %>%
  distinct(ID.P, JOURNAL) %>%
  group_by(JOURNAL) %>%
  summarise(no_studies = n()) %>%
  mutate(pct = no_studies / sum(no_studies)) %>%
  arrange(desc(no_studies))

pub.jounal.data
```

**Total number of countries represented in the publications**

```{r}
# preparing dataset
pub.countries.data <-
  database %>%
  filter(INCLUDED == TRUE) %>%
  dplyr::select(ID.P, STUDY.LOC.COUNTRY) %>%
  mutate_if(is.character, as.factor) %>%
  distinct(ID.P, STUDY.LOC.COUNTRY) %>%
  group_by(STUDY.LOC.COUNTRY) %>%
  summarise(no_studies = n()) %>%
  mutate(pct = no_studies / sum(no_studies)) %>%
  arrange(desc(no_studies))

pub.countries.data
```

**Publications and experiments per country**

Most prevailing countries - where most studies (per independent study) have been conducted

```{r Preparing dataset on publications and experiments per country}
# using n_independent_studies

pub.country.paper <-
  database %>%
  filter(INCLUDED == TRUE) %>%
  dplyr::select(ID.P, STUDY.LOC.COUNTRY) %>%
  # based on n_independent_studies
  distinct(ID.P, STUDY.LOC.COUNTRY) %>%
  group_by(STUDY.LOC.COUNTRY) %>%
  summarise(no_studies = n()) %>%
  mutate(pct = (no_studies / sum(no_studies))) %>%
  mutate_if(is.integer, as.numeric) %>%
  arrange(desc(no_studies)) %>%
  top_n(10, wt = no_studies)

# using n_individual_sites
pub.country.sites <-
  database %>%
  filter(INCLUDED == TRUE) %>%
  dplyr::select(ID.S, STUDY.LOC.COUNTRY) %>%
  # based on n_individual_sites
  distinct(ID.S, STUDY.LOC.COUNTRY) %>%
  group_by(STUDY.LOC.COUNTRY) %>%
  summarise(no_studies = n()) %>%
  mutate(pct = (no_studies / sum(no_studies))) %>%
  mutate_if(is.integer, as.numeric) %>%
  arrange(desc(no_studies)) %>%
  top_n(10, wt = no_studies)
```

```{r PLOTTING - Publications per country}
pub.country.paper %>%
  ggplot(aes(x = reorder(STUDY.LOC.COUNTRY, no_studies), y = no_studies)) +
  geom_col(fill = my_col_single, alpha = 0.8) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 3, vjust = 0, hjust = -0.5) +
  ylim(c(0, 20)) +
  labs(
    title = "Number of peer-reviewed publications for the top ten most represented countries",
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "",
    y = "Number of publications"
  ) +
  coord_flip()
```

*Saving last plot*

```{r}
ggsave(
  filename = "pub.country.paper.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 30, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

```{r PLOTTING - Study sites per country}
pub.country.sites %>%
  ggplot(aes(x = reorder(STUDY.LOC.COUNTRY, no_studies), y = no_studies)) +
  geom_col(fill = my_col_single, alpha = 0.8) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 3, vjust = 0, hjust = -0.5) +
  ylim(c(0, 20)) +
  labs(
    title = "Number of study sites for the top ten most represented countries",
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "",
    y = "Number of publications"
  ) +
  coord_flip()
```

*Saving last plot*

```{r}
ggsave(
  filename = "pub.country.sites.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 30, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Temporal scale of studies

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

temp.scale <- vroom::vroom("./DATASET.FROM.SCRIPT/temp.scale.csv") 
```

*Preparing data for pie-donut chart*

```{r}
# Building a table with the data for the plot
temporal.scale.PD.data <- temp.scale %>%
  group_by(Tier_1_scale, Tier_2_scale) %>%
  summarise(n = sum(count)) %>%
  dplyr::mutate(Tier_1_scale = replace_na(Tier_1_scale, "NA")) %>%
  dplyr::mutate(Tier_2_scale = replace_na(Tier_1_scale, "NA")) %>%
  ungroup()
```

**Pie-Donut chart**

```{r warning=FALSE, message=FALSE}
# Pie-Donut chart
webr::PieDonut(temporal.scale.PD.data,
  aes(Tier_1_scale, Tier_2_scale, count = n),
  ratioByGroup = TRUE,
  showPieName = FALSE,
  addDonutLabel = FALSE,
  showRatioDonut = FALSE,
  showRatioPie = TRUE,
  title = "Temporal scale used by studies",
  r0 = 0.5,
  r1 = 1.2,
  r2 = 1.5,
  start = 3 * pi / 4,
  selected = c(1, 2),
  explode = c(1, 2),
  explodeDonut = TRUE,
  explodePos = 0.15,
  explodePie = TRUE,
  labelpositionThreshold = 0.8,
  showRatioThreshold = 0.001,
  labelposition = 8,
  maxx = 2,
  use.labels = TRUE,
  donutLabelSize = 3.6,
  pieLabelSize = 3.8,
  pieAlpha = 0.8
)
# scale_fill_manual(values = colorspace::qualitative_hcl(8, palette = "Dynamic")))
```

## Spatial scale of studies

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

spatial.scale <- vroom::vroom("./DATASET.FROM.SCRIPT/spatial.scale.csv") 
```

*Preparing data for pie-donut chart*

```{r}
# Building a table with the data for the plot
spatial.scale.PD.data <- spatial.scale %>% 
  group_by(Tier_1_scale, Tier_2_scale) %>%
  summarise(n = sum(count)) %>%
  ungroup()
```

**Pie-Donut chart**

```{r warning=FALSE, message=FALSE}
# Pie-Donut chart
webr::PieDonut(spatial.scale.PD.data,
  aes(Tier_1_scale, Tier_2_scale, count = n),
  ratioByGroup = FALSE,
  showPieName = FALSE,
  addDonutLabel = FALSE,
  showRatioDonut = TRUE,
  showRatioPie = TRUE,
  title = "Spatial scale used by studies",
  r0 = 0.5,
  r1 = 1.2,
  r2 = 1.5,
  start = 3 * pi / 4,
  selected = c(1, 2),
  explode = c(2, 3),
  explodeDonut = TRUE,
  explodePos = 0.15,
  explodePie = TRUE,
  labelpositionThreshold = 0.8,
  showRatioThreshold = 0.001,
  labelposition = 8,
  maxx = 2.1,
  use.labels = TRUE,
  donutLabelSize = 3.6,
  pieLabelSize = 3.8,
  pieAlpha = 0.8
)
# scale_fill_manual(values = colorspace::qualitative_hcl(8, palette = "Dynamic")))
```

## Approach used by studies to assess ecosystem services

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

ES.study.approach.PD.data <- vroom::vroom("./DATASET.FROM.SCRIPT/ES.study.approach.PD.data.csv") 
```

**Pie-Donut chart**

```{r warning=FALSE, message=FALSE}
# Pie-Donut chart
webr::PieDonut(ES.study.approach.PD.data,
  aes(Approach, Ecosystem_Service, count = n),
  ratioByGroup = FALSE,
  showPieName = FALSE,
  addDonutLabel = FALSE,
  showRatioDonut = FALSE,
  showRatioPie = TRUE,
  title = "Ecosystem services devided on study approach",
  r0 = 0.4,
  r1 = 1.1,
  r2 = 1.6,
  explode = c(1, 2, 3, 4),
  start = 3 * pi / 5,
  # selected = c(1, 2, 3, 4, 5, 6, 7),
  explodeDonut = FALSE,
  explodePos = 0.4,
  labelpositionThreshold = 0.3,
  showRatioThreshold = 0.001,
  labelposition = 0.3,
  maxx = 2.7,
  use.labels = FALSE,
  donutLabelSize = 3.6,
  pieLabelSize = 3.8,
  pieAlpha = 0.8
)
```

-   RQ1: What are the current themes of knowledge abundance and scarcity as related to temperate silvoarable agroforestry systems?

-   RQ1.a - Which silvoarable agroforestry systems, are highly represented and which a poorly represented?

## SAF System Trait Types

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

system.trait.data <- vroom::vroom("./DATASET.FROM.SCRIPT/system.trait.data.csv") 
```

**Barplot of silvoarable system traits**

```{r PLOTTING - Barplot of silvoarable system traits, tidy=TRUE}
# using n_individual_study_sites because system traits vary between sites, as some studies include multiple sites with different species compositions and arrangements.
system.trait.plot <-
  system.trait.data %>%
  ggplot(aes(
    x = reorder(ST.TYPE, -count),
    y = count
  )) +
  geom_bar(
    stat = "identity",
    fill = my_col_single,
    alpha = 0.8
  ) +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 3, vjust = -2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  ylim(c(0, 100)) +
  labs(
    title = "Distribution of silvoarable system trait types",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies = ", n_independent_studies),
    x = "Silvoarable system trait type",
    y = "n (records)"
  )

system.trait.plot
```

## Functional role (product type) of the tree component in SAF systems

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

system.trait.products <- vroom::vroom("./DATASET.FROM.SCRIPT/system.trait.products.csv") 
```

**Barplot of the functional role (product type) of tree component**

```{r}
system.trait.products.plot <-
  system.trait.products %>%
  ggplot(aes(x = reorder(ST.TYPE.PROD.TYPE, count), y = count)) +
  geom_bar(
    stat = "identity",
    fill = my_col_single,
    alpha = 0.9
  ) +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 6, vjust = -2) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(system.trait.products$ST.TYPE.PROD.TYPE)),
    text = element_text(size = 20)
  ) +
  ylim(c(0, 180)) +
  labs( # title = "Frequency of tree functional types",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0("Total number of independent studies = ", n_independent_studies),
    caption = paste("n (individual study sites) = ", n_individual_study_sites),
    x = "Main function of tree component (product type)",
    y = "n records"
  )

system.trait.products.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "system.trait.products.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 20, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Spatial arrangements (interrow distance)

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

spatial.arrange.data <- vroom::vroom("./DATASET.FROM.SCRIPT/spatial.arrange.data.csv") 
```

**Histogram of the interrow distance distribution**

```{r Histogram of the interrow distance distribution, warning=FALSE, tidy=TRUE}

interrow <-
  spatial.arrange.data %>%
  filter(CA.DIST.INTERROW != "NA")

overall_mean_interrow <- mean(interrow$CA.DIST.INTERROW)

# Plotting histogram and desity plot using the cowplot function

# 1. Create the histogram plot
p_histogram <-
  spatial.arrange.data %>%
  # Add the density curve on the same axis
  gghistogram(
    x = "CA.DIST.INTERROW", y = "..count..",
    add = "mean", col = "black", rug = TRUE,
    fill = my_col_single,
    alpha = 0.8,
    binwidth = 5,
    add_density = FALSE
  ) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  # scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ylim(c(0, 30)) +
  annotate("text", # Add text for mean
    x = overall_mean_interrow * 2,
    y = overall_mean_interrow * 1,
    label = paste("Mean =", overall_mean_interrow),
    col = my_col_single,
    size = 4
  ) +
  labs(
    title = "Distribution of interrow distances for silvoarable alley cropping systems",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Alley interrow distance (m)",
    y = "Number of sites having a given interrow distance"
  )

# 2. Create the density plot with y-axis on the right
# Remove x axis elements
p_density <-
  spatial.arrange.data %>%
  ggdensity(
    x = "CA.DIST.INTERROW",
    colour = my_col_single,
    alpha = 0
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)), position = "right") +
  theme_half_open(11, rel_small = 1) +
  rremove("x.axis") +
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend") +
  labs(y = "Density distribution of a given interrow distance")

# 3. Align the two plots and then overlay them.
aligned_plots <- cowplot::align_plots(p_histogram, p_density, align = "hv", axis = "tblr")

histodensity.spatial.arrangements <-
  ggdraw(aligned_plots[[1]]) + draw_plot(aligned_plots[[2]])

# ------------------------------------------------------------------------------------------------------------------------------
# using n_individual_study_sites because system traits vary between sites, as some studies include multiple sites with different species compositions and arrangements.

histodensity.spatial.arrangements
```

*Saving last plot*

```{r}
ggsave(
  filename = "histodensity.spatial.arrangements.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 20, 
  height = 10, 
  units = "cm",
  dpi = 500
)
```

**Ridgeline plot of interrow distances for different SAF system trait types**

*Defining dataset with average distances per SAF system trait type*

```{r}
spatial.arrange.data.interrow <-
  spatial.arrange.data %>%
  dplyr::mutate(ST.TYPE = case_when(
    str_detect(ST.TYPE, "RBS") ~ "Riparian buffer strips",
    str_detect(ST.TYPE, "SHB") ~ "Line belts *",
    str_detect(ST.TYPE, "MIXED") ~ "Mixed systems",
    str_detect(ST.TYPE, "TIMBER.ARABLE") ~ "Timber - Arable",
    str_detect(ST.TYPE, "BIOMASS.ARABLE") ~ "Biomass - Arable",
    str_detect(ST.TYPE, "NUT.ARABLE") ~ "Nut - Arable",
    str_detect(ST.TYPE, "FRUIT.ARABLE") ~ "Fruit - Arable",
    TRUE ~ as.character(as.character(ST.TYPE))
  )) %>%
  mutate_if(is.numeric, as.integer) %>%
  drop_na(CA.DIST.INTERROW) %>%
  dplyr::filter(CA.DIST.INTERROW <= 100)
```

**Ridgeline plot**

```{r}
spatial.arrange.ridge.plot <-
  spatial.arrange.data.interrow %>%
  mutate(text = fct_reorder(ST.TYPE, -CA.DIST.INTERROW)) %>%
  ggplot() +
  geom_density_ridges(aes(
    y = reorder(ST.TYPE, -CA.DIST.INTERROW),
    x = CA.DIST.INTERROW,
    fill = ST.TYPE
  ),
  alpha = 0.6,
  # quantile_lines = TRUE, quantiles = 2,
  quantile_lines = TRUE,
  quantile_fun = mean,
  show.legend = FALSE
  ) +
  scale_fill_manual(values = colorspace::qualitative_hcl(6, palette = "Dynamic")) +
  theme_bw() +
  theme(text = element_text(size = 20)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)) +
  labs( # title = "Distribution of interrow distances across the different SAF system trait types",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of individual studies = ", n_individual_study_sites),
    caption = paste0("Total number of individual studies = ", n_individual_study_sites),
    x = "Interrow distance [m]",
    y = "SAF system trait type"
  )

spatial.arrange.ridge.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "spatial.arrange.ridge.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 20, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

**Table; differences in interrow distances between SAF system trait types**

```{r converting dataframe ti flextable and viewing}
# converting dataframe (tibble) to a flextable class (https://ardata-fr.github.io/flextable-book/)
spatial.arrange.data.interrow.ft <- flextable(spatial.arrange.data.interrow %>%
  group_by(ST.TYPE) %>%
  drop_na(CA.DIST.INTERROW) %>%
  summarise(avr_interrow_dist = mean(CA.DIST.INTERROW)) %>%
  mutate(across(where(is.numeric), round, 2)))

# setting headers
spatial.arrange.data.interrow.ft <- set_header_labels(spatial.arrange.data.interrow.ft,
  ST.TYPE = "SAF System Trait Type",
  avr_interrow_dist = "Average interrow distance [m]"
)

# setting table properties
spatial.arrange.data.interrow.ft <- set_table_properties(spatial.arrange.data.interrow.ft,
  layout = "autofit",
  width = 0.6
)


# viewing the exported table - crop groups
spatial.arrange.data.interrow.ft
```

*Exporting interrow distance table into to png*

```{r Exporting the table, warning=FALSE, message=FALSE, eval=FALSE}
# saving / exporting the flextable to local disk as ".png"
flextable::save_as_image(spatial.arrange.data.interrow.ft, path = "./FIGURES.OUTPUT.FROM.SCRIPT/spatial.arrange.data.interrow.ft.png")
```

-   RQ1.b - Which crop and tree species are highly represented and which a poorly represented?

## Crops, crop species and crop groups

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

crops.data <- vroom::vroom("./DATASET.FROM.SCRIPT/crops.data.csv") 
```

Generated broad categories of crop species is based on broad output product based on FAO, 2019. FAOSTAT database. <http://www.fao.org/faostat/en/#data>.

**Number of different crop species found in the dataset**

```{r}
crops.data.species.unique <- crops.data %>% 
  distinct(CROP.SPECIES) %>%
  nrow()

crops.data.species.unique
```

**Number of different crop genera found in the dataset**

```{r}
crops.data.genus.unique <- crops.data %>% 
  dplyr::select(ID.P, ID.S,
         CROP.SPECIES, CROP.GENUS.GROUP, CROP.SPECIES.GROUP) %>%
  distinct(CROP.GENUS.GROUP) %>%
  nrow()

crops.data.genus.unique
```

**Table; frequency of occurrence of various crop groups**

```{r converting dataframe ti flextable and viewing}
# converting dataframe (tibble) to a flextable class (https://ardata-fr.github.io/flextable-book/)
crops.data.aggr.ft <- flextable(crops.data.aggr %>%
  dplyr::select(-n) %>%
  arrange(desc(count)))

# setting headers
crops.data.aggr.ft <- set_header_labels(crops.data.aggr.ft,
  CROP.OUTPUT.GROUP = "Crop group",
  count = "n records",
  pct = "%"
)

# setting table properties
crops.data.aggr.ft <- set_table_properties(crops.data.aggr.ft,
  layout = "autofit",
  width = 0.6
)


# viewing the exported table - crop groups
crops.data.aggr.ft
```

*Exporting crop group table into to png*

```{r Exporting the table, warning=FALSE, message=FALSE, eval=FALSE}
# saving / exporting the flextable to local disk as ".png"
flextable::save_as_image(crops.data.aggr.ft, path = "./FIGURES.OUTPUT.FROM.SCRIPT/crops.data.aggr.png")
```

**Barplot of annual crop group distribution**

```{r PLOTTING - Annual crop group distribution, tidy=TRUE}
# using n_individual_study_sites because crop species vary between sites, as some studies include multiple sites with different species compositions and arrangements.

crops.data.aggr.plot <-
  crops.data.aggr %>%
  ggplot(aes(x = reorder(CROP.OUTPUT.GROUP, count), y = count)) +
  geom_bar(
    stat = "identity",
    fill = my_col_single,
    alpha = 0.8
  ) +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 3, vjust = -2) +
  labs(
    x = "Crop species",
    y = "n (records)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(crops.data.aggr$CROP.OUTPUT.GROUP))
  ) +
  ylim(c(0, 350)) +
  labs(
    title = "Distribution of aggregated crop species groups",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Aggregated crop species groups"
  )
```

**Only cereals only - split-up**

```{r Splitting up the largest group of crops (Cereals)}
# n of cereal crops and pct
crops.data.cereals <- crops.data %>%
  filter(CROP.OUTPUT.GROUP != "NA") %>%
  # excluding 41 records of 'NA'
  group_by(CROP.SPECIES) %>%
  summarise(count = n()) %>%
  add_tally(wt = count) %>%
  mutate(pct = (count / n)) %>%
  arrange(desc(count)) %>%
  filter(grepl("Triticum|Zea|Hordeum|Secale|Avena|Sorghum|Fagopyrum", CROP.SPECIES)) %>%
  # filtering only cereals
  filter(count >= 10)

```

**Bar plot; cereals only**

```{r Plot of the largest group of crops (Cereals)}
crops.data.cereals.plot <-
  ggplot(
    data = crops.data.cereals,
    aes(x = reorder(CROP.SPECIES, count), y = count)
  ) +
  geom_bar(
    stat = "identity",
    fill = my_col_single,
    alpha = 0.8
  ) +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 3, vjust = -1) +
  theme_bw(12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    axis.title.x = element_blank(), axis.title.y = element_blank(),
    plot.margin = margin(l = -30 + margin_spacer(crops.data.cereals$CROP.SPECIES))
  ) +
  ylim(c(0, 200)) +
  labs(title = "Cereal crop species")
```

**Combining plots - in patchwork (like cowplot)**

```{r PLOTTING - combined plot of all crop groups and the largest group of crops (Cereals)}
crops.plot <-
  ggdraw(crops.data.aggr.plot + theme_bw(12) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(margin = margin(40, 40, 40, 40)),
      legend.position = "none"
    )) +
  draw_plot(crops.data.cereals.plot, .20, .55, .3, .3) + # x, y, x, y

  draw_plot_label(
    c("A", "B"),
    c(.05, .25), # x(A), x(B)
    c(0.95, 0.85), # y(A), y(B)
    size = 12
  )


crops.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "crops.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 20, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Trees, tree species and tree genera

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

trees.data <- vroom::vroom("./DATASET.FROM.SCRIPT/trees.data.csv") 
```

**Number of different tree species**

```{r}
tree.data.species.unique <- trees.data %>% 
  filter(!grepl("spp.", TREE.SPECIES)) %>% # excluding 'spp.' species
  distinct(TREE.SPECIES) %>%
  nrow()

tree.data.species.unique
```

**Number of different tree genera**

```{r}
tree.data.genus.unique <- trees.data %>%
  filter(!grepl("HAY|UNSPECIFIED|HERBS|SP|NA|NS", TREE.SPECIES)) %>%
  # removing 'unreal' species
  # Generating broad categories of tree species - based on families, genus and hybrids
  separate(TREE.SPECIES, c("TREE.GENUS.GROUP", "TREE.SPECIES.GROUP"), "^\\S*\\K\\s+", remove = FALSE) %>%
  dplyr::select(
    ID.P, ID.S,
    TREE.SPECIES, TREE.GENUS.GROUP, TREE.SPECIES.GROUP
  ) %>%
  distinct(TREE.GENUS.GROUP) %>%
  nrow()

tree.data.genus.unique
```

**Table; tree species group data**

```{r Print tree species group data, tidy=TRUE}
# colnames is a character vector of length 5, and we replace it
datatable(head(trees.data.aggr, 20),
          colnames = c('Tree genus group (aggregated by genus)', 'Number of records', 'Proportions'),
          options = list(order = list(list(2, 'desc'))))
```

**Barplot of tree species group distribution**

```{r PLOTTING - Tree species group distribution, tidy=TRUE}
# using n_individual_study_sites because crop species vary between sites, as some studies include multiple sites with different species compositions and arrangements.
trees.data.aggr.plot <-
  ggplot(
    data = trees.data.aggr,
    aes(
      x = TREE.GENUS.GROUP,
      y = count
    )
  ) +
  geom_bar(
    stat = "identity",
    fill = my_col_single,
    alpha = 0.8
  ) +
  geom_text(aes(label = paste0(round(pct * 100, 1), "%")), size = 3, vjust = -2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  ylim(c(0, 120)) +
  labs(
    title = "Distribution of aggregated tree family groups",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Tree genus groups (agregated)",
    y = "n(records)"
  )

trees.data.aggr.plot
```

**Populus only - split-up**

```{r Splitting up the largest group of trees (Populus)}
trees.data.populus <-
  trees.data %>%
  relocate(
    ID.P, ID.S,
    TREE.SPECIES, TREE.GENUS.GROUP
  ) %>%
  filter(TREE.GENUS.GROUP == "Populus") %>%
  group_by(TREE.SPECIES) %>%
  summarise(count = n()) %>%
  mutate(pct = (count / sum(count))) %>%
  arrange(desc(-count)) %>%
  filter(TREE.SPECIES != "NA") %>%
  filter(count >= 5)

```

-   RQ1.c - Which biodiversity and ecosystem services are highly represented and which a poorly represented in different systems?

## Biodiversity indicators

**Loading dataset**

```{r Loading data - SAF system trait types (agroforestry system types)}

biodiversity.data <- vroom::vroom("./DATASET.FROM.SCRIPT/biodiversity.data.csv") 
```

**Biodiversity total reported**

```{r}
biodiversity.reported <-
  database %>%
  filter(INCLUDED == TRUE) %>%
  # selecting Biodiversity columns
  dplyr::select(
    ID.P, ID.S, # ST.TYPE, MANAGEMENT
    starts_with("BD")
  ) %>%
  mutate(across(matches("BD"), as.logical)) %>%
  mutate_at(vars(-c(ID.P, ID.S)), tidyr::replace_na, 0) %>%
  # <- Including NA's as 0 (FALSE)
  mutate_if(is.logical, as.numeric) %>%
  mutate_if(is.character, as.numeric) %>%
  dplyr::select(-c(ID.S)) %>%
  distinct(ID.P, across(contains("BD"))) # including only independent studies and not separate study sites


# sum the data using apply
biodiversity.sum.data <-
  data.frame(value = apply(biodiversity.reported, MARGIN = 2, FUN = sum))

biodiversity.sum.data$key <- rownames(biodiversity.sum.data)

biodiversity.total <-
  biodiversity.sum.data %>%
  rename(
    count = value,
    BD.INDICATORS = key
  ) %>%
  filter(BD.INDICATORS == "BD") %>%
  mutate(pct_of_total = (count / n_independent_studies))

biodiversity.total
```

**Barplot; biodiversity-related indicators reported by independent studies**

```{r PLOTTING - biodiversity-related indicators reported in papers}
# using n_independent_studies because biodiversity and ecosystem service related indicators do not (normally) vary between sites, because independent studies look at the same variables (biodiversity and ecosystem service) even if several individual study sites are used for the study.

# total number of peer-reviewed papers reporting on biodiversity-related indicators
total_n_BD <- biodiversity.sum.data %>%
  filter(key == "BD")

# plotting the biodiversity bar plots for independent studies
biodiversity.plot <- biodiversity.data %>%
  ggplot(aes(
    x = reorder(BD.GROUPS, -count),
    y = count
  )) +
  geom_bar(
    stat = "identity",
    fill = my_col_single,
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 35)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    text = element_text(size = 18)
  ) +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 5, vjust = -2) +
  labs( # title = "Distribution of biodiversity-related indicators reported by peer-reviewed papers",
    # subtitle = paste("n (independent studies) reporting on biodiversity = ", total_n_BD),
    caption = paste0(
      "Total number of independent studies = ", n_independent_studies,
      " and n (independent studies) reporting on biodiversity = ", total_n_BD
    ),
    x = "Biodiversity indicator groups",
    y = "n(observations)"
  )

# Hence, out of the total number of papers 31 are recording on biodiversity-related indicators. The percentages however are based on the total number of papers (73): For instance, for fungi = (73/10) * 100 =

biodiversity.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "biodiversity.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 25, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services

**Loading dataset**

```{r }

ecosystem.data <- vroom::vroom("./DATASET.FROM.SCRIPT/ecosystem.data.csv") 
```

**Preparing ES dataset**

```{r Preparing the ecosystem service data}
# ---------------------------------------------------------------------------------------------------
# sum the ES data using apply

ecosystem.sum.data <-
  data.frame(value = apply(ecosystem.data, MARGIN = 2, FUN = sum))


ecosystem.sum.data$key <- rownames(ecosystem.sum.data)

# ---------------------------------------------------------------------------------------------------

ecosystem.plot.data <-
  ecosystem.sum.data %>%
  rename(
    count = value,
    ES.INDICATORS = key
  ) %>%
  filter(ES.INDICATORS == "Provisioning ES" |
    ES.INDICATORS == "Regulating ES" |
    ES.INDICATORS == "Supporting ES" |
    ES.INDICATORS == "Cultural ES") %>%
  # grouping, counting and preparing groups for plotting
  group_by(ES.INDICATORS) %>%
  summarise(count = sum(count)) %>%
  # the proportion of individual ecosystem services-related indicators relative to the total number of papers: How many papers report on        ecosystem services-related indicators
  mutate(pct_of_total = (count / n_independent_studies)) %>%
  arrange(desc(-count))
```

**Ecosystem services total reported**

```{r}
ecosystem.sum.data %>%
  rename(count = value,
         ES.INDICATORS =  key) %>%
  filter(ES.INDICATORS == "Ecosystem Services") %>%
   mutate(pct_of_total = (count/n_independent_studies))
```

**Percentage of various ES representation** Calculating the percentage of various ES representation and isolating total n of ES to be used in plotting

```{r Percentage of various ES representation}
total_ES_pct <- ecosystem.sum.data %>%
  rename(
    count = value,
    ES.INDICATORS = key
  ) %>%
  dplyr::filter(ES.INDICATORS != "NA") %>%
  # excluding 41 records of 'NA'
  dplyr::filter(ES.INDICATORS != "ID.P" &
    ES.INDICATORS != "Provisioning ES" &
    ES.INDICATORS != "Regulating ES" &
    ES.INDICATORS != "Supporting ES" &
    ES.INDICATORS != "Cultural ES" &
    ES.INDICATORS != "Ecosystem Services") %>%
  # excluding ID.P recordings
  add_tally(wt = count) %>%
  mutate(pct = (count / n)) %>%
  dplyr::select(n)

total_n_records_ES_for_pct <- total_ES_pct[, 1]
total_n_records_ES_for_pct <- total_n_records_ES_for_pct[1]
```

**Bar plots;** **Broad categories of ecosystem services reported by independent studies**

```{r PLOTTING - broad categories of ecosystem services}
# using n_independent_studies because biodiversity and ecosystem service related indicators do not (normally) vary between sites, because independent studies look at the same variables (biodiversity and ecosystem service) even if several individual study sites are used for the study.

ecosystem.plot.broad <-
  ecosystem.plot.data %>%
  ggplot(aes(
    x = reorder(ES.INDICATORS, -count),
    y = count,
    fill = ES.INDICATORS
  )) +
  geom_bar(
    stat = "identity",
    fill = my_cols_pal_four,
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 60)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    text = element_text(size = 20)
  ) +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 8, vjust = -2) +
  labs( # title = "Distribution of ecosystem service indicators reported by peer-reviewed papers",
    subtitle = paste("n (independent studies) reporting on ecosystem services = ", total_n_ES),
    # caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Ecosystem service categories",
    y = "n(records)"
  )

ecosystem.plot.broad
```

**Provision**

```{r Preparing provision data}
# ---------------------------------------------------------------------------------------------------
total_n_prov_ES <- ecosystem.sum.data %>%
  filter(key == "ES.PROV")
# ---------------------------------------------------------------------------------------------------


# ---------------------------------------------------------------------------------------------------

ecosystem.prov.plot.data <-
  ecosystem.sum.data %>%
  rename(
    count = value,
    ES.INDICATORS = key
  ) %>%
  pivot_wider(names_from = ES.INDICATORS, values_from = count) %>%
  dplyr::select(
    "Food (yield)",
    "Feed",
    "Fibre",
    "Fuel (firewood etc.)",
    "Genetic resources",
    "Biochemicals",
    "Ornamentals",
    "Fresh water"
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "ES.SUB.PROV.INDICATORS",
    values_to = "count"
  ) %>%
  # grouping, counting and preparing groups for plotting
  group_by(ES.SUB.PROV.INDICATORS) %>%
  summarise(count = sum(count)) %>%
  # the proportion of individual provisioning ecosystem services-related indicators relative to the total number of papers: How many    papers report on provisioning ecosystem services-related indicators
  mutate(pct_of_total = (count / n_independent_studies)) %>%
  arrange(desc(-count))
```

*Bar plot; provisioning ES*

```{r PLOTTING - provision}
ecosystem.prov.plot <-
  ecosystem.prov.plot.data %>%
  ggplot(aes(
    x = reorder(ES.SUB.PROV.INDICATORS, -count),
    y = count,
    fill = ES.SUB.PROV.INDICATORS
  )) +
  geom_bar(
    stat = "identity",
    fill = my_cols_pal_four[4],
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 50)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    axis.title.x = element_blank(), axis.title.y = element_blank(),
    plot.margin = margin(l = 0 + margin_spacer(ecosystem.prov.plot.data$ES.SUB.PROV.INDICATORS)),
    text = element_text(size = 15)
  ) +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 4, vjust = -2) +
  labs(
    title = "Provisioning ES",
    subtitle = paste("n (independent studies) = ", total_n_prov_ES)
  )
# caption = paste0("Total number of independent studies = ", n_independent_studies))
```

**Supporting**

```{r Preparing supporting data}
# ---------------------------------------------------------------------------------------------------
total_n_supp_ES <- ecosystem.sum.data %>%
  filter(key == "ES.SUPP")
# ---------------------------------------------------------------------------------------------------

ecosystem.supp.plot.data <-
  ecosystem.sum.data %>%
  rename(
    count = value,
    ES.INDICATORS = key
  ) %>%
  pivot_wider(names_from = ES.INDICATORS, values_from = count) %>%
  dplyr::select(
    "Soil formation",
    "Photosynthesis",
    "Primary production",
    "Nutrient cycling",
    "Water cycling"
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "ES.SUB.SUPP.INDICATORS",
    values_to = "count"
  ) %>%
  # grouping, counting and preparing groups for plotting
  group_by(ES.SUB.SUPP.INDICATORS) %>%
  summarise(count = sum(count)) %>%
  # the proportion of individual supporting ecosystem services-related indicators relative to the total number of papers: How many    papers report on supporting ecosystem services-related indicators
  mutate(pct_of_total = (count / n_independent_studies)) %>%
  arrange(desc(-count))
```

*Bar plot; supporting ES*

```{r PLOTTING - supporting}
ecosystem.supp.plot <-
  ecosystem.supp.plot.data %>%
  ggplot(aes(
    x = reorder(ES.SUB.SUPP.INDICATORS, -count),
    y = count,
    fill = ES.SUB.SUPP.INDICATORS
  )) +
  geom_bar(
    stat = "identity",
    fill = my_cols_pal_four[3],
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 50)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    axis.title.x = element_blank(), axis.title.y = element_blank(),
    plot.margin = margin(l = 0 + margin_spacer(ecosystem.supp.plot.data$ES.SUB.SUPP.INDICATORS)),
    text = element_text(size = 15)
  ) +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 4, vjust = -2) +
  labs(
    title = "Supporting ES",
    subtitle = paste("n (independent studies) = ", total_n_supp_ES)
  )
# caption = paste0("Total number of independent studies = ", n_independent_studies))
```

**Regulating**

```{r Preparing regulating data}
# ---------------------------------------------------------------------------------------------------
total_n_regu_ES <- ecosystem.sum.data %>%
  filter(key == "ES.REGU")
# ---------------------------------------------------------------------------------------------------

ecosystem.regu.plot.data <-
  ecosystem.sum.data %>%
  rename(
    count = value,
    ES.INDICATORS = key
  ) %>%
  pivot_wider(names_from = ES.INDICATORS, values_from = count) %>%
  dplyr::select(
    "Air regulation",
    "Climate regulation",
    "Carbon sequestration",
    "Water regulation",
    "Nutrient leaching regulation",
    "Erosion regulation",
    "Water purification",
    "Disease regulation",
    "Pest regulation",
    "Polination regulation",
    "Natural hazards regulation"
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "ES.SUB.REGU.INDICATORS",
    values_to = "count"
  ) %>%
  # grouping, counting and preparing groups for plotting
  group_by(ES.SUB.REGU.INDICATORS) %>%
  summarise(count = sum(count)) %>%
  # the proportion of individual regulating ecosystem services-related indicators relative to the total number of papers: How many    papers report on regulating ecosystem services-related indicators
  mutate(pct_of_total = (count / n_independent_studies)) %>%
  arrange(desc(-count))
```

*Bar plot; regulating ES*

```{r PLOTTING - regulating}
ecosystem.regu.plot <-
  ecosystem.regu.plot.data %>%
  ggplot(aes(
    x = reorder(ES.SUB.REGU.INDICATORS, -count),
    y = count,
    fill = ES.SUB.REGU.INDICATORS
  )) +
  geom_bar(
    stat = "identity",
    fill = my_cols_pal_four[2],
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 50)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    axis.title.x = element_blank(), axis.title.y = element_blank(),
    plot.margin = margin(l = 0 + margin_spacer(ecosystem.regu.plot.data$ES.SUB.REGU.INDICATORS)),
    text = element_text(size = 15)
  ) +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 4, vjust = -2) +
  labs(
    title = "Regulating ES",
    subtitle = paste("n (independent studies) = ", total_n_regu_ES)
  )
# caption = paste0("Total number of independent studies = ", n_independent_studies))
```

**Cultural**

```{r Preparing cultural data}
# ---------------------------------------------------------------------------------------------------
total_n_cult_ES <- ecosystem.sum.data %>%
  filter(key == "ES.CULT")
# ---------------------------------------------------------------------------------------------------

ecosystem.cult.plot.data <-
  ecosystem.sum.data %>%
  rename(
    count = value,
    ES.INDICATORS = key
  ) %>%
  pivot_wider(names_from = ES.INDICATORS, values_from = count) %>%
  dplyr::select(
    "Cultural diversity",
    "Spiritual value",
    "Knowledge systems",
    "Educational value",
    "Inspirational value",
    "Aesthetic value",
    "Social relations",
    "Sense of place",
    "Cultural heritage value",
    "Recreational and ecotourism"
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "ES.SUB.CULT.INDICATORS",
    values_to = "count"
  ) %>%
  # grouping, counting and preparing groups for plotting
  group_by(ES.SUB.CULT.INDICATORS) %>%
  summarise(count = sum(count)) %>%
  # the proportion of individual cultural ecosystem services-related indicators relative to the total number of papers: How many    papers report on cultural ecosystem services-related indicators
  mutate(pct_of_total = (count / n_independent_studies)) %>%
  arrange(desc(-count))
```

*Bar plot; cultural ES*

```{r PLOTTING - cultural}
ecosystem.cult.plot <-
  ecosystem.cult.plot.data %>%
  ggplot(aes(
    x = reorder(ES.SUB.CULT.INDICATORS, -count),
    y = count,
    fill = ES.SUB.CULT.INDICATORS
  )) +
  geom_bar(
    stat = "identity",
    fill = my_cols_pal_four[1],
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 50)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    axis.title.x = element_blank(), axis.title.y = element_blank(),
    plot.margin = margin(l = 0 + margin_spacer(ecosystem.cult.plot.data$ES.SUB.CULT.INDICATORS)),
    text = element_text(size = 15)
  ) +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 4, vjust = -2) +
  labs(
    title = "Cultural ES",
    subtitle = paste("n (independent studies) = ", total_n_cult_ES)
  )
# caption = paste0("Total number of independent studies = ", n_independent_studies))
```

**Combined ES bar plot; collecting in cowplot**

```{r PLOTTING - combined ecosystem service data in cowplot}
# ecosystem.plot <- list(ecosystem.prov.plot, ecosystem.supp.plot, ecosystem.regu.plot, ecosystem.cult.plot)
# plot_grid(plotlist = ecosystem.plot,
#           ncol = 2, align = 'v')
#
# ecosystem.plot.all <- list(ecosystem.prov.plot,
#                            ecosystem.supp.plot,
#                            ecosystem.regu.plot,
#                            ecosystem.cult.plot)

side_col <- plot_grid(ecosystem.prov.plot,
  ecosystem.supp.plot,
  ecosystem.regu.plot,
  ecosystem.cult.plot,
  labels = c("B", "C", "D", "E"),
  align = "h"
)

ES.cowplot.grid <-
  plot_grid(ecosystem.plot.broad, side_col,
    ncol = 2,
    nrow = 1,
    labels = c("A", ""),
    rel_heights = c(1.2, 1)
  )

ES.cowplot.grid
```

*Saving last plot*

```{r}
ggsave(
  filename = "ES.cowplot.grid.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 60, 
  height = 20, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services; frequency of occurance (using Pie-Donut chart)

**Loading dataset**

```{r }

ecosystem.sum.data.PD.tier1.tier2 <- vroom::vroom("./DATASET.FROM.SCRIPT/ecosystem.sum.data.PD.tier1.tier2.csv") 
```

*Preparing ecosystem service data for Pie-Donut plot*

```{r}
# Building a table with the data for the plot
ES.PD.data <- ecosystem.sum.data.PD.tier1.tier2 %>% 
  group_by(ES.TIER1.GROUP, ES.TIER2.GROUP) %>%
  rename("ES_Tier_1" = ES.TIER1.GROUP) %>%
  rename("ES_Tier_2" = ES.TIER2.GROUP) %>%
  summarise(n = sum(value)) %>%
  ungroup()
```

**Pie-Donut plot ecosystem services**

```{r warning=FALSE, message=FALSE}
# Pie-Donut chart
ES.PieDonut.plot <-
  webr::PieDonut(ES.PD.data,
    aes(ES_Tier_1, ES_Tier_2, count = n),
    ratioByGroup = TRUE,
    showPieName = FALSE,
    addDonutLabel = FALSE,
    showRatioDonut = FALSE,
    showRatioPie = TRUE,
    title = "Ecosystem services frequency of occurance",
    r0 = 0.4,
    r1 = 1.1,
    r2 = 1.6,
    explode = c(1, 2, 3, 4),
    start = 3 * pi / 2,
    # selected = c(1, 2, 3, 4, 5, 6, 7),
    explodeDonut = TRUE,
    explodePos = 0.05,
    labelpositionThreshold = 0.2,
    showRatioThreshold = 0.007,
    labelposition = 0.3,
    maxx = 2.9,
    use.labels = FALSE,
    donutLabelSize = 2.8,
    pieLabelSize = 2.8,
    pieAlpha = 0.8
  )

# ES.PieDonut.plot
```

## Categories of Approach

**Loading dataset**

```{r }

categories.data <- vroom::vroom("./DATASET.FROM.SCRIPT/categories.data.csv") 
```

**Preparing categories dataset**

```{r }
# ---------------------------------------------------------------------------------------------------
# sum the data using apply

categories.sum <-
  data.frame(value = apply(categories.data, MARGIN = 2, FUN = sum))


categories.sum$key <- rownames(categories.sum)

# ---------------------------------------------------------------------------------------------------

category.plot.data <-
  categories.sum %>%
  rename(
    count = value,
    CAT.INDICATORS = key
  ) %>%
  filter(CAT.INDICATORS == "Agronomic category" |
    CAT.INDICATORS == "Environmental category" |
    CAT.INDICATORS == "Economic category" |
    CAT.INDICATORS == "Socio-cultural category") %>%
  # grouping, counting and preparing groups for plotting
  group_by(CAT.INDICATORS) %>%
  summarise(count = sum(count)) %>%
  # the proportion of individual category-related indicators relative to the total number of papers: How many papers report on        category-related indicators
  mutate(pct_of_total = (count / n_independent_studies)) %>%
  arrange(desc(-count))
```

**Bar plot; broad categories of approach reported by independent studies**

```{r PLOTTING - broad categories of approach}
# using n_independent_studies because categories of approach related indicators do not (normally) vary between sites, because independent studies look at the same variables (categories of approach) even if several individual study sites are used for the study.
category.plot.broad <-
  category.plot.data %>%
  ggplot(aes(
    x = reorder(CAT.INDICATORS, -count),
    y = count,
    fill = CAT.INDICATORS
  )) +
  geom_bar(
    stat = "identity",
    fill = my_cols_pal_four,
    alpha = 0.8
  ) +
  theme_bw() +
  ylim(c(0, 75)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(t = 10, r = 2, b = 0, l = 2, unit = "pt")
  ) +
  # plot.margin = margin(l = 0 + margin_spacer(category.plot.data$CAT.INDICATORS)))  +
  geom_text(aes(label = paste0(round(pct_of_total * 100, 1), "%")), size = 3, vjust = -2) +
  labs(
    title = "Distribution of categories of approach indicators reported by peer-reviewed papers",
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Categories of approach",
    y = "n(records)"
  )

category.plot.broad
```

## Combined ES + CAT dataset

To create (1) broad focus groups of ecosystem services as well as (2) selected ecosystem services we use information from the *data dimensions*; **ecosystem services**, **biodiversity** and **categories of approach**. Following the style of *Ditzler et al. (2021)*, *Duru et al. (2015)* and *Tamburini et al. (2020)*

Also, to create a combined dataset for assessing **input / output ES** we base the grouping of ecosystem services on the *data dimensions*; **ecosystem services** and **categories of approach** combined. Following the methodology of *Ditzler et al. (2021)* and *Duru et al. (2015)*

**Loading dataset**

```{r }

category.ecosystem.long <- vroom::vroom("./DATASET.FROM.SCRIPT/category.ecosystem.long.csv") 
```

**Input/output Ecosystem Services**

*Total input and output ES recorded*

```{r}
category.ecosystem.long %>%
  drop_na(INPUT.OUTPUT.ES) %>%
  group_by(INPUT.OUTPUT.ES) %>%
  summarise(n_input.output = n())
```

# Visualising of multivariate datasets; Matrices

## Tree - crop associations

**Loading datasets**

```{r }
# tree species
matrix.crop.species.tree.all <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.crop.species.tree.all.csv") 
# tree groups
matrix.crop.groups.tree.all <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.crop.groups.tree.all.csv") 
```

**Matrix; tree genera - crop groups**

```{r PLOTTING the crop groups - tree dataset matrix, warning=FALSE, message=FALSE}
# using n_independent_studies
matrix.tree.genera.crop.group.plot <-
  matrix.crop.groups.tree.all %>%
  ggplot(aes(
    x = reorder(TREE.GENUS.GROUP, -count),
    y = reorder(CROP.OUTPUT.GROUP, -count),
    fill = CROP.OUTPUT.GROUP
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.1,
    width = 0.1,
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "right",
    text = element_text(size = 20)
  ) +
  guides(size = guide_legend(title = ""), fill = FALSE) +
  scale_size_continuous(range = c(4, 15)) +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs( # title = "Matrix showing the associations between tree genera and crop groups reported in peer-reviewed papers",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0("n(independent studies) = ", n_independent_studies),
    x = "Tree genera",
    y = "Crop groups"
  )
matrix.tree.genera.crop.group.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "matrix.tree.genera.crop.group.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 40, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

**Matrix; tree genera - crop species**

```{r PLOTTING the associations of crop species - tree dataset matrix, warning=FALSE, message=FALSE}
# using n_independent_studies
matrix.crop.species.tree.genera <-
  matrix.crop.species.tree.all %>%
  ggplot(aes(
    x = reorder(TREE.GENUS.GROUP, -count),
    y = reorder(CROP.GENUS.GROUP, -count),
    fill = CROP.GENUS.GROUP
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.6,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  scale_size_continuous(range = c(2, 10)) +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the associations between tree genera and crop species reported in peer-reviewed papers",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("n(independent studies) = ", n_independent_studies),
    x = "Tree genera",
    y = "Crop species"
  )

matrix.crop.species.tree.genera
```

*Saving last plot*

```{r}
ggsave(
  filename = "matrix.crop.species.tree.genera.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 40, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

**Frequency of occurrences of associations of crop genera and tree genera**

```{r Assessing the frequency of associations occurrencesfor crop genera and tree genera}
matrix.crop.species.tree.all %>%
  group_by(CROP.GENUS.GROUP, TREE.GENUS.GROUP) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>% 
  mutate(pct = (count/sum(n_individual_study_sites))) %>%
  arrange(desc(TREE.GENUS.GROUP), desc(count))
```

## Biodiversity indicators - crops

**Loading dataset**

```{r }

matrix.crop.biodiversity.all <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.crop.biodiversity.all.csv") 
```

**Matrix; biodiversity - crop groups**

```{r PLOTTING the biodiversity-crops dataset matrix, warning=FALSE, message=FALSE}
# using n_individual_study_sites because crop species vary between sites, as some studies include multiple sites with different species compositions and arrangements.

matrix.crop.biodiversity.all %>%
  ggplot(aes(
    x = reorder(CROP.OUTPUT.GROUP, -count),
    y = reorder(name, -count),
    fill = CROP.OUTPUT.GROUP
  )) +
  geom_point(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8
  ) +
  scale_size_area(max_size = 20, guide = "none") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(crops.data$CROP.OUTPUT.GROUP))
  ) +
  scale_size_continuous(range = c(-1, 25)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the number of peer-reviewed papers reporting on biodiversity-related indicators for different crop groups",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("n(independent studies) reporting on biodiversity-related indicators = ", total_n_BD$value),
    x = "Crop groups",
    y = "Biodiversity-related indicators"
  )
```

## Biodiversity indicators - SAF system trait types

**Loading dataset**

```{r }

matrix.biodiversity.systrait <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.biodiversity.systrait.csv") 
```

**Matrix; biodiversity - SAF system trait types**

```{r PLOTTING - biodiversity-system trait type dataset matrix}
matrix.biodiversity.systrait %>%
  ggplot(aes(
    x = reorder(ST.TYPE, -count),
    y = reorder(name, -count),
    fill = ST.TYPE
  )) +
  geom_point(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8
  ) +
  scale_size_area(max_size = 20, guide = "none") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(matrix.biodiversity.systrait$ST.TYPE))
  ) +
  scale_size_continuous(range = c(-1, 25)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the number of peer-reviewed papers reporting on biodiversity-related indicators for different system trait types",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("n(independent studies) reporting on biodiversity-related indicators = ", total_n_BD$value),
    x = "Crop groups",
    y = "Biodiversity-related indicators"
  )
```

## Ecosystem services (broad ecosystem services) - crop groups

**Loading dataset**

```{r }

matrix.crop.ecosystem <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.crop.ecosystem.csv") 
```

**Matrix; ecosystem services - crop groups**

```{r PLOTTING - ecosystem services-crops dataset matrix}
# using n_individual_study_sites because crop species vary between sites, as some studies include multiple sites with different species compositions and arrangements.

matrix.crop.ecosystem %>%
  ggplot(aes(
    x = reorder(CROP.OUTPUT.GROUP, -count),
    y = reorder(name, -count),
    fill = CROP.OUTPUT.GROUP
  )) +
  geom_point(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8
  ) +
  scale_size_area(max_size = 20, guide = "none") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(crops.data$CROP.OUTPUT.GROUP))
  ) +
  scale_size_continuous(range = c(-1, 25)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the number of peer-reviewed papers reporting on ecosystem services for different crop groups",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("n(independent studies) reporting on ecosystem services = ", total_n_ES$value),
    x = "Crop groups",
    y = "Ecosystem services"
  )
```

## Ecosystem services - SAF system trait types

**Loading dataset**

```{r }

matrix.ecosystem.systrait <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.ecosystem.systrait.csv") 
```

**Matrix; ecosystem services - SAF system trait types**

```{r PLOTTING - biodiversity-system trait type dataset matrix}
matrix.ecosystem.systrait %>%
  ggplot(aes(
    x = reorder(ST.TYPE, -count),
    y = reorder(name, -count),
    fill = ST.TYPE
  )) +
  geom_point(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8
  ) +
  scale_size_area(max_size = 20, guide = "none") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(matrix.ecosystem.systrait$ST.TYPE))
  ) +
  scale_size_continuous(range = c(-1, 20)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the number of peer-reviewed papers reporting on ecosystem services for different system trait types",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("n(independent studies) reporting on ecosystem services = ", total_n_ES$value),
    x = "System Trait types",
    y = "Ecosystem services"
  )
```

## Input/output ecosystem services

**Loading dataset**

```{r }

matrix.inoutES.pub.yr.all <- vroom::vroom("./DATASET.FROM.SCRIPT/matrix.inoutES.pub.yr.all.csv") 
```

**Developments of input/output ES and publication years** *Matrix; input/output ES - publication year*

```{r PLOTTING the input/output ES - publication year dataset matrix, warning=FALSE, message=FALSE}
# using n_independent_studies
inoutES.pub.yr.all.plot <-
  matrix.inoutES.pub.yr.all %>%
  ggplot(aes(
    x = PUB.YR,
    y = INPUT.OUTPUT.ES,
    shape = ES.CAT.GROUPS,
    colour = ES.CAT.GROUPS
  )) +
  geom_jitter(aes(size = count),
    # colour = "black",
    alpha = 0.8,
    height = 0.4,
    width = 2.5
  ) +
  scale_size_area(max_size = 20, guide = "none") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  # scale_x_discrete(limits = c("Agronomy", "Environment", "Economic", "Cultural")) +  # Change the order of legend items
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom") +
  guides(shape = guide_legend(title = ""), colour = guide_legend(title = "")) +
  scale_x_continuous(breaks = pretty(matrix.inoutES.pub.yr.all$PUB.YR, n = 20), minor_breaks = 1, limits = c(1990, 2022)) +
  scale_y_discrete(labels = c("Input ES", "Output ES")) +
  scale_size_continuous(range = c(2, 5)) +
  guides(size = guide_bins(direction = "horizontal", show.limits = TRUE)) +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the number of peer-reviewed papers reporting on input/output ES for different years of publication",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("n(independent studies) reporting on ES indicators = ", total_n_ES$value),
    x = "Year",
    y = "Ecosystem services"
  )

inoutES.pub.yr.all.plot
```

## Ecosystem services (broad focus groups of ecosystem services) - crop groups - tree genera

To create (1) broad focus groups of ecosystem services as well as (2) selected ecosystem services we use information from the *data dimensions*; **ecosystem services**, **biodiversity** and **categories of approach**. Following the style of *Ditzler et al. (2021)*, *Duru et al. (2015)* and *Tamburini et al. (2020)*

**Loading dataset**

```{r }

joined.focus.ES.crops.trees <- vroom::vroom("./DATASET.FROM.SCRIPT/joined.focus.ES.crops.trees.csv") 
```

*Plotting in a matrix*

```{r PLOTTING - FOCUS.GROUPS.BD.ES.CAT ecosystem services, warning=FALSE, message=FALSE}
focus.ES.crops.trees.plot <- joined.focus.ES.crops.trees %>%
  drop_na(TREE.GENUS.GROUP, CROP.OUTPUT.GROUP, FOCUS.GROUPS.BD.ES.CAT) %>%
  na.omit(TREE.GENUS.GROUP, CROP.OUTPUT.GROUP, FOCUS.GROUPS.BD.ES.CAT) %>%
  group_by(FOCUS.GROUPS.BD.ES.CAT, CROP.OUTPUT.GROUP, TREE.GENUS.GROUP) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  ggplot(aes(
    x = reorder(FOCUS.GROUPS.BD.ES.CAT, -count),
    y = reorder(TREE.GENUS.GROUP, -count),
    fill = CROP.OUTPUT.GROUP
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(joined.focus.ES.crops.trees$FOCUS.GROUPS.BD.ES.CAT))
  ) +
  scale_size_continuous(range = c(1, 12)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs( # title = "Matrix showing the frequency of associations of crop groups, ecosystem services for different silvoarable systems reported by peer-reviewed papers",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    x = "Silvoarable System Trait Types",
    y = "Selected ecosystem services"
  ) +
  facet_grid(. ~ CROP.OUTPUT.GROUP)

focus.ES.crops.trees.plot
```

## Ecosystem services (selected ecosystem services) - crop groups - SAF system trait types

**Loading dataset**

```{r }

ES.selected.crop.groups.SATF <- vroom::vroom("./DATASET.FROM.SCRIPT/ES.selected.crop.groups.SATF.csv") 
```

**Matrix; selected ecosystem services - crop groups - SAF system trait types**

```{r PLOTTING - selected ecosystem services (including biodiversity and categories data) with crop groups, warning=FALSE, message=FALSE}
ES.cat.crop.groups.SATF.plot <- ES.selected.crop.groups.SATF %>%
  group_by(ES.GROUPS, CROP.OUTPUT.GROUP, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  ggplot(aes(
    x = reorder(`SAF System Trait type`, -count),
    y = reorder(ES.GROUPS, -count),
    fill = CROP.OUTPUT.GROUP
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.9,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(matrix.es.bd.cat.systrait.crop.all$CROP.OUTPUT.GROUP)),
    text = element_text(size = 18)
  ) +
  scale_size_continuous(range = c(1, 10)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs( # title = "Matrix showing the frequency of associations of crop groups, ecosystem services for different silvoarable systems reported by peer-reviewed papers",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    caption = paste("n (individual study sites) = ", n_individual_study_sites),
    x = "Silvoarable System Trait Types",
    y = "Selected ecosystem services"
  ) +
  facet_grid(. ~ CROP.OUTPUT.GROUP)

ES.cat.crop.groups.SATF.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "ES.cat.crop.groups.SATF.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 48, 
  height = 18, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services (focus group ecosystem services) - crop groups - SAF system trait types

**Loading dataset**

```{r }

joined.focus.ES.SAFT <- vroom::vroom("./DATASET.FROM.SCRIPT/joined.focus.ES.SAFT.csv") 
```

**Matrix; focus group ecosystem services - crop groups - SAF system trait types**

```{r PLOTTING - FOCUS.GROUPS.BD.ES.CAT ecosystem services, warning=FALSE, message=FALSE}
focus.ES.SAFT.plot <- joined.focus.ES.SAFT %>%
  drop_na() %>%
  na.omit() %>%
  group_by(FOCUS.GROUPS.BD.ES.CAT, CROP.OUTPUT.GROUP, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  ggplot(aes(
    x = reorder(CROP.OUTPUT.GROUP, -count),
    y = reorder(FOCUS.GROUPS.BD.ES.CAT, -count),
    fill = FOCUS.GROUPS.BD.ES.CAT
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.08,
    width = 0.08
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    # plot.margin = margin(l = 0 + margin_spacer(joined.inoutES.crops.trees$FOCUS.GROUPS.BD.ES.CAT)),
    text = element_text(size = 14)
  ) +
  scale_size_continuous(range = c(1, 12)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  # guides(size = guide_legend(title = ""), fill = FALSE) +
  labs( # title = "Matrix showing the frequency of associations of crop groups, ecosystem services for different silvoarable systems reported by peer-reviewed papers",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    x = "Crop groups",
    y = "Ecosystem service categories"
  ) +
  facet_grid(. ~ factor(`SAF System Trait type`, levels = c("Timber - Arable", "Biomass - Arable", "Nut - Arable", "Fruit - Arable", "Line belts *", "Mixed systems", "Riparian buffer strips")))

focus.ES.SAFT.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "focus.ES.SAFT.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services (selected ecosystem services) - countries of publication

**Loading dataset**

```{r }

ES.countries.crops.SAFT <- vroom::vroom("./DATASET.FROM.SCRIPT/ES.countries.crops.SAFT.csv") 
```

**Matrix; selected ecosystem services - SAF system trait types - countries**

```{r PLOTTING - selected ecosystem services (including biodiversity and categories data) with countries, warning=FALSE, message=FALSE}
D_JOINED_COUNTRIES_CROPS_ES_SAFT %>%
  group_by(STUDY.LOC.COUNTRY, ES.GROUPS, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  na.omit() %>%
  ggplot(aes(
    x = reorder(STUDY.LOC.COUNTRY, -count),
    y = reorder(ES.GROUPS, -count),
    fill = STUDY.LOC.COUNTRY
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
    plot.margin = margin(l = 0 + margin_spacer(D_JOINED_COUNTRIES_CROPS_ES_SAFT$STUDY.LOC.COUNTRY))
  ) +
  scale_size_continuous(range = c(1, 10)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the frequency of associations of ecosystem services for different silvoarable systems across top ten most represented countries of publication reported by peer-reviewed papers",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    x = "Countries",
    y = "Selected ecosystem services"
  ) +
  facet_grid(. ~ factor(`SAF System Trait type`, levels = c("Timber - Arable", "Biomass - Arable", "Nut - Arable", "Fruit - Arable", "Line belts *", "Riparian buffer strips", "Mixed systems")))
```

# Geospatial data; singel variate data (not matrices)

**Loading and preparing dataset with coordinates**

```{r Loading dataset with lat long coordinates}

database.lat.lon <- vroom::vroom("./DATASET.FROM.SCRIPT/database.lat.lon.csv") %>%
  filter(INCLUDED == TRUE) %>%
  mutate(`SAF System Trait type` = recode(ST.TYPE, # rename dataframe rows
    RBS = "Riparian buffer strips",
    SHB = "Line belts *",
    MIXED = "Mixed systems",
    TIMBER.ARABLE = "Timber - Arable",
    BIOMASS.ARABLE = "Biomass - Arable",
    NUT.ARABLE = "Nut - Arable",
    FRUIT.ARABLE = "Fruit - Arable",
    .keep = "all"
  )) %>%
  dplyr::mutate(ST.TYPE.PROD.TYPE = "x") %>%
  mutate(ST.TYPE.PROD.TYPE = recode(ST.TYPE, # rename dataframe rows
    TIMBER.ARABLE = "Biomass",
    BIOMASS.ARABLE = "Biomass",
    NUT.ARABLE = "Food",
    FRUIT.ARABLE = "Food",
    RBS = "Multiple",
    SHB = "Multiple",
    MIXED = "Multiple",
    .keep = "all"
  )) 

glimpse(database.lat.lon)
```

*Defining number of independent studies and number of observations based on individual study sites*

```{r Number of studies and study sites}
n_independent_studies <- database.lat.lon %>% 
  distinct(ID.P) %>%
  nrow()

# n_independent_studies = 73 (16 aug. 2022)

n_individual_study_sites <- database.lat.lon %>%
  distinct(ID.P, ID.S) %>%
  nrow()

# n_individual_study_sites = 213 (16 aug. 2022)
```

*Re-locating the column names to get a better overview of lat long*

```{r Re-locating the column names to get lat long}
database.lat.lon <-
  database.lat.lon %>%
  relocate(
    ID.P, ID.S, TITLE,
    latitude, longitude, STUDY.LOC.COUNTRY, STUDY.LOC.SPEC, STUDY.LOC.SPEC.COORDS
  )

# View(database.lat.lon) # <-  un-comment to see the database with lat long
```

*Listing study sites with missing value in the latitude column*

```{r Study sites with missing lat (long) values, eval=FALSE}
location.missing <- database.lat.lon %>%
  filter_all(any_vars(is.na(latitude))) %>%
  relocate(ID.P, ID.S, TITLE,
           latitude, longitude, STUDY.LOC.COUNTRY, STUDY.LOC.SPEC, STUDY.LOC.SPEC.COORDS)

# View(location.missing)

# Replacing the observations that have missing values in 'Location Specification' with the information from the general 'Location' column

# 28 studies had missing information for the latitude column (location missing). These were then manually checked and a nearby location was added where possible by re-visiting the papers and checking the study sites on Google Maps. The previous lines of code was run again, now with  zero (0) missing locations. 
```

## Explorative analysis

**Visualising the locations on a map**

```{r Quick plot of the locations on a map}
# using n_individual_study_sites because some studies include multiple sites with different system traits, species compositions and arrangements.

database.lat.lon %>%
  ggplot(aes(longitude, latitude), color = "grey99") +
  borders("world") +
  geom_point(aes(color = ST.TYPE), size = 0.5, alpha = 0.8) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Visualising peer-reviewed silvoarable paper' study site locations on a map",
    subtitle = paste("n (study sites) = ", n_individual_study_sites),
    x = "Longitude",
    y = "Latitude"
  )
```

**Most prevailing countries - where most studies (study sites) have been conducted**

```{r Where most studies (study sites) have been conducted}
# using n_individual_study_sites because system traits vary between sites, as some studies include multiple sites with different species compositions and arrangements.

database.lat.lon %>%
  count(STUDY.LOC.COUNTRY, sort = TRUE)


# using n_independent_studies

pub.country.geo <-
  database.lat.lon %>%
  dplyr::filter(INCLUDED == TRUE) %>%
  dplyr::select(ID.P, STUDY.LOC.COUNTRY) %>%
  distinct(ID.P, STUDY.LOC.COUNTRY) %>%
  group_by(STUDY.LOC.COUNTRY) %>%
  summarise(no_studies = n()) %>%
  dplyr::mutate_if(is.integer, as.numeric) %>%
  dplyr::filter(no_studies > 2) %>%
  arrange(desc(no_studies))
```

**Loading the combined database with location-specific biophysical (bioclim + soil) data**

```{r Loading location-specific biopphysical dataset, warning=FALSE, message=FALSE}

database.biophys <- vroom::vroom("./DATASET.FROM.SCRIPT/database.biophys.csv") %>%
  filter(INCLUDED == TRUE) %>%
  mutate(`SAF System Trait type` = recode(ST.TYPE, # rename dataframe rows
    RBS = "Riparian buffer strips",
    SHB = "Line belts *",
    MIXED = "Mixed systems",
    TIMBER.ARABLE = "Timber - Arable",
    BIOMASS.ARABLE = "Biomass - Arable",
    NUT.ARABLE = "Nut - Arable",
    FRUIT.ARABLE = "Fruit - Arable",
    .keep = "all"
  )) %>%
  dplyr::mutate(ST.TYPE.PROD.TYPE = "x") %>%
  mutate(ST.TYPE.PROD.TYPE = recode(ST.TYPE, # rename dataframe rows
    TIMBER.ARABLE = "Biomass",
    BIOMASS.ARABLE = "Biomass",
    NUT.ARABLE = "Food",
    FRUIT.ARABLE = "Food",
    RBS = "Multiple",
    SHB = "Multiple",
    MIXED = "Multiple",
    .keep = "all"
  ))
```

## Trees - biophys

**Loading dataset**

```{r }

trees.biophys.data <- vroom::vroom("./DATASET.FROM.SCRIPT/trees.biophys.data.csv") 
```

## Tree genera - temperature

**Violin plot; tree genera - tempreature**

```{r PLOTTING - tree genera in relation to temperature, warning=FALSE, message=FALSE}
# number of observations per tree group
trees.coords.data.N <-
  trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(Temp > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>%
  mutate(N = n()) %>%
  mutate(N = ifelse(TREE.FAMILY.GROUP == max(TREE.FAMILY.GROUP, na.rm = T), paste0("n=", N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
trees.temp.violin.plot <-
  trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(Temp > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>%
  filter(n() >= 5) %>%
  ggplot(aes(y = Temp / 10, x = reorder(TREE.FAMILY.GROUP, Temp))) +
  geom_violin(aes(fill = TREE.FAMILY.GROUP, alpha = 0.8)) +
  geom_jitter(
    height = 5, width = 0.1,
    size = 1.1, aes(col = TREE.FAMILY.GROUP, alpha = 1)
  ) +
  stat_summary(
    fun.data = "mean_sdl", fun.args = list(mult = 1),
    geom = "pointrange", color = "black"
  ) +
  theme_bw() +
  ylim(0, 20) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of tree genera across temperature gradients",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Tree genera",
    y = "Annual Mean Temperature [C]"
  ) +
  coord_flip()


trees.temp.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "trees.temp.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Tree genera - precipitation

**Violin plot; tree genera - precipitation**

```{r PLOTTING - tree genera in relation to precipitation, warning=FALSE, message=FALSE}
trees.prec.violin.plot <-
  trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(Prec > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>%
  filter(n() >= 10) %>%
  ggplot(aes(y = Prec, x = reorder(TREE.FAMILY.GROUP, Prec))) +
  geom_violin(aes(fill = TREE.FAMILY.GROUP, alpha = 0.8)) +
  geom_jitter(
    height = 5, width = 0.1,
    size = 1.1, aes(col = TREE.FAMILY.GROUP, alpha = 1)
  ) +
  stat_summary(
    fun.data = "mean_sdl", fun.args = list(mult = 1),
    geom = "pointrange", color = "black"
  ) +
  theme_bw() +
  ylim(0, 1500) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  labs(
    title = "Distribution of tree family genera across precipitation gradients",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Tree genera",
    y = "Annual Precipitation [mm]"
  ) +
  coord_flip()

trees.prec.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "trees.prec.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

Random lm model to check for relationship between **tree genera and temperature**

```{r}
model.lm <- lm(Temp ~ TREE.FAMILY.GROUP, data = trees.biophys.data)
summary(model.lm)
```

## Tree genera - soil sand content

```{r PLOTTING - tree genera in relation to soil sand content, warning=FALSE, message=FALSE}
# number of observations per tree group
trees.soil.data.data.N <- 
  trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(sandmean > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(TREE.FAMILY.GROUP == max(TREE.FAMILY.GROUP, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 10) %>%
  distinct(N)

# generating plot
trees.sand.violin.plot <- 
trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(sandmean > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>% 
  filter(n() >= 10) %>%

  ggplot(aes(y = sandmean, x = reorder(TREE.FAMILY.GROUP, sandmean))) +
  geom_violin(aes(fill = TREE.FAMILY.GROUP, alpha = 0.7)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = TREE.FAMILY.GROUP, alpha = 0.8)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of tree genera across soil sand content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "Tree genera",
       y = "Soil sand content [%]") +
  coord_flip()
  
trees.sand.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "trees.sand.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Tree genera - soil clay content

```{r PLOTTING - tree genera in relation to soil clay content, warning=FALSE, message=FALSE}
# number of observations per tree group
trees.soil.data.data.N <- 
  trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(claymean > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(TREE.FAMILY.GROUP == max(TREE.FAMILY.GROUP, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 10) %>%
  distinct(N)

# generating plot
trees.clay.violin.plot <- 
trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(claymean > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>% 
  filter(n() >= 10) %>%

  ggplot(aes(y = claymean, x = reorder(TREE.FAMILY.GROUP, claymean))) +
  geom_violin(aes(fill = TREE.FAMILY.GROUP, alpha = 0.7)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = TREE.FAMILY.GROUP, alpha = 0.8)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of tree genera across soil clay content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "Tree genera",
       y = "Soil clay content [%]") +
  coord_flip()
  

trees.clay.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "trees.sand.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Tree genera - SOC content

```{r PLOTTING - tree genera in relation to soil soc content, warning=FALSE, message=FALSE}
# number of observations per tree group
trees.soil.data.data.N <- 
  trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(socmean > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(TREE.FAMILY.GROUP == max(TREE.FAMILY.GROUP, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 10) %>%
  distinct(N)

# generating plot
trees.soc.violin.plot <- 
trees.biophys.data %>%
  filter(TREE.FAMILY.GROUP != "NA") %>%
  filter(socmean > 0) %>%
  group_by(TREE.FAMILY.GROUP) %>% 
  filter(n() >= 10) %>%

  ggplot(aes(y = socmean, x = reorder(TREE.FAMILY.GROUP, socmean))) +
  geom_violin(aes(fill = TREE.FAMILY.GROUP, alpha = 0.7)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = TREE.FAMILY.GROUP, alpha = 0.8)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of tree genera across soc content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "Tree genera",
       y = "SOC content [%]") +
  coord_flip()
  

trees.soc.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "trees.soc.violin.plott.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Crops - biophys

**Loading dataset**

```{r }

crops.biophys.data <- vroom::vroom("./DATASET.FROM.SCRIPT/crops.biophys.data.csv") 
```

## Crop (species) - temperature

**Violin plot - crop species - temperature**

```{r PLOTTING - crop species in relation to temperature, warning=FALSE, message=FALSE}
# number of observations per tree group
crops.coords.data.N <-
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  filter(Temp > 0) %>%
  group_by(CROP.GENUS.GROUP) %>%
  mutate(N = n()) %>%
  mutate(N = ifelse(CROP.GENUS.GROUP == max(CROP.GENUS.GROUP, na.rm = T), paste0("n=", N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
crops.temp.violin.plot <-
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  filter(Temp > 0) %>%
  group_by(CROP.GENUS.GROUP) %>%
  filter(n() >= 8) %>%
  ggplot(aes(y = Temp / 10, x = reorder(CROP.GENUS.GROUP, Temp))) +
  geom_violin(aes(fill = CROP.GENUS.GROUP, alpha = 0.8)) +
  geom_jitter(
    height = 5, width = 0.1,
    size = 1.1, aes(col = CROP.GENUS.GROUP, alpha = 1)
  ) +
  stat_summary(
    fun.data = "mean_sdl", fun.args = list(mult = 1),
    geom = "pointrange", color = "black"
  ) +
  theme_bw() +
  ylim(0, 20) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of crop groups across temperature gradients",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Crop groups",
    y = "Annual Mean Temperature [C]"
  ) +
  coord_flip()


crops.temp.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "crops.temp.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Crops(species) - precipitation

```{r PLOTTING - crop groups in relation to precipitation, warning=FALSE, message=FALSE}
# number of observations per tree group
crops.coords.data.N <-
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  filter(Prec > 0) %>%
  group_by(CROP.GENUS.GROUP) %>%
  mutate(N = n()) %>%
  mutate(N = ifelse(CROP.GENUS.GROUP == max(CROP.GENUS.GROUP, na.rm = T), paste0("n=", N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
crops.prec.violin.plot <-
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  filter(Prec > 0) %>%
  group_by(CROP.GENUS.GROUP) %>%
  filter(n() >= 8) %>%
  ggplot(aes(y = Prec, x = reorder(CROP.GENUS.GROUP, Prec))) +
  geom_violin(aes(fill = CROP.GENUS.GROUP, alpha = 0.8)) +
  geom_jitter(
    height = 5, width = 0.1,
    size = 1.1, aes(col = CROP.GENUS.GROUP, alpha = 1)
  ) +
  stat_summary(
    fun.data = "mean_sdl", fun.args = list(mult = 1),
    geom = "pointrange", color = "black"
  ) +
  theme_bw() +
  ylim(0, 1500) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of crop groups across precipitation gradients",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Crop groups",
    y = "Annual Precipitation [mm]"
  ) +
  coord_flip()


crops.prec.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "crops.prec.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Crop (genera) - soil sand content

```{r PLOTTING - crop genera in relation to soil sand content, warning=FALSE, message=FALSE}
# number of observations per crop group
crops.soil.data.data.N <- 
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  filter(sandmean > 0) %>%
  group_by(CROP.GENUS.GROUP) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(CROP.GENUS.GROUP == max(CROP.GENUS.GROUP, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 10) %>%
  distinct(N)

# generating plot
crops.sand.violin.plot <- 
crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  filter(sandmean > 0) %>%
  group_by(CROP.GENUS.GROUP) %>% 
  filter(n() >= 20) %>%

  ggplot(aes(y = sandmean, x = reorder(CROP.GENUS.GROUP, sandmean))) +
  geom_violin(aes(fill = CROP.GENUS.GROUP, alpha = 0.7)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = CROP.GENUS.GROUP, alpha = 0.8)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of crop genera across soil sand content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "crop genera",
       y = "Soil sand content [%]") +
  coord_flip()
  

crops.sand.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "crops.sand.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Crop (genera) - soil clay content

```{r PLOTTING - crop genera in relation to soil clay content, warning=FALSE, message=FALSE}
# number of observations per crop group
crops.soil.data.data.N <- 
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  distinct(CROP.GENUS.GROUP, claymean) %>%
  filter(claymean > 0) %>%
  group_by(CROP.GENUS.GROUP) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(CROP.GENUS.GROUP == max(CROP.GENUS.GROUP, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 10) %>%
  distinct(N)

# generating plot
crops.clay.violin.plot <- 
crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  distinct(CROP.GENUS.GROUP, claymean) %>%
  filter(claymean > 0) %>%
  group_by(CROP.GENUS.GROUP) %>% 
  filter(n() >= 20) %>%

  ggplot(aes(y = claymean, x = reorder(CROP.GENUS.GROUP, claymean))) +
  geom_violin(aes(fill = CROP.GENUS.GROUP, alpha = 0.7)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = CROP.GENUS.GROUP, alpha = 0.8)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of crop genera across soil clay content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "crop genera",
       y = "Soil clay content [%]") +
  coord_flip()
  

crops.clay.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "crops.sand.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Crop genera - SOC content

```{r PLOTTING - crop genera in relation to soil soc content, warning=FALSE, message=FALSE}
# number of observations per crop group
crops.soil.data.data.N <- 
  crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  distinct(CROP.GENUS.GROUP, socmean) %>%
  filter(socmean > 0) %>%
  group_by(CROP.GENUS.GROUP) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(CROP.GENUS.GROUP == max(CROP.GENUS.GROUP, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 10) %>%
  distinct(N)

# generating plot
crops.soc.violin.plot <- 
crops.biophys.data %>%
  filter(CROP.GENUS.GROUP != "NA") %>%
  distinct(CROP.GENUS.GROUP, socmean) %>%
  filter(socmean > 0) %>%
  group_by(CROP.GENUS.GROUP) %>% 
  filter(n() >= 20) %>%

  ggplot(aes(y = socmean, x = reorder(CROP.GENUS.GROUP, socmean))) +
  geom_violin(aes(fill = CROP.GENUS.GROUP, alpha = 0.7)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = CROP.GENUS.GROUP, alpha = 0.8)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of crop genera across soil soc content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "crop genera",
       y = "Soil soc content [%]") +
  coord_flip()
  

crops.soc.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "crops.soc.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## SAF system trait types - biophys

**Loading dataset**

```{r }

systrait.biophys.data <- vroom::vroom("./DATASET.FROM.SCRIPT/systrait.biophys.data.csv") %>%
    mutate(`SAF System Trait type` = recode(ST.TYPE, # rename dataframe rows
    RBS = "Riparian buffer strips",
    SHB = "Line belts *",
    MIXED = "Mixed systems",
    TIMBER.ARABLE = "Timber - Arable",
    BIOMASS.ARABLE = "Biomass - Arable",
    NUT.ARABLE = "Nut - Arable",
    FRUIT.ARABLE = "Fruit - Arable",
    .keep = "all"
  )) %>%
  dplyr::mutate(ST.TYPE.PROD.TYPE = "x") %>%
  mutate(ST.TYPE.PROD.TYPE = recode(ST.TYPE, # rename dataframe rows
    TIMBER.ARABLE = "Biomass",
    BIOMASS.ARABLE = "Biomass",
    NUT.ARABLE = "Food",
    FRUIT.ARABLE = "Food",
    RBS = "Multiple",
    SHB = "Multiple",
    MIXED = "Multiple",
    .keep = "all"
  ))
```

## SAF system trait types - temperature

**Violin plot; SAF system trait types - temperature**

```{r PLOTTING - system trait types in relation to temperature, warning=FALSE, message=FALSE}
# number of observations per system trait types
systrait.coords.data.N <-
  systrait.biophys.data %>%
  # distinct SAF system trait types and temp
  distinct(`SAF System Trait type`, Temp) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(Temp > 0) %>%
  group_by(`SAF System Trait type`) %>%
  mutate(N = n()) %>%
  mutate(N = ifelse(`SAF System Trait type` == max(`SAF System Trait type`, na.rm = T), paste0("n=", N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
systrait.temp.violin.plot <-
  systrait.biophys.data %>%
  # distinct SAF system trait types and temp
  distinct(`SAF System Trait type`, Temp) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(Temp > 0) %>%
  group_by(`SAF System Trait type`) %>%
  filter(n() >= 5) %>%
  ggplot(aes(y = Temp / 10, x = reorder(`SAF System Trait type`, Temp))) +
  geom_violin(aes(fill = `SAF System Trait type`, alpha = 0.8)) +
  geom_jitter(
    height = 5, width = 0.1,
    size = 1.1, aes(col = `SAF System Trait type`, alpha = 1)
  ) +
  stat_summary(
    fun.data = "mean_sdl", fun.args = list(mult = 1),
    geom = "pointrange", color = "black"
  ) +
  theme_bw() +
  # ylim(0, 20) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of SAF system trait types across temperature gradients",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "SAF system trait types",
    y = "Annual Mean Temperature [C]"
  ) +
  coord_flip()


systrait.temp.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "systrait.temp.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## SAF system trait types - precipitation

**Violin plot; SAF system trait types - precipitation**

```{r PLOTTING - system trait types in relation to precipitation, warning=FALSE, message=FALSE}
# number of observations per tree group
systrait.coords.data.N <-
  systrait.biophys.data %>%
  # distinct SAF system trait types and precipitation
  distinct(`SAF System Trait type`, Prec) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(Prec > 0) %>%
  group_by(`SAF System Trait type`) %>%
  mutate(N = n()) %>%
  mutate(N = ifelse(`SAF System Trait type` == max(`SAF System Trait type`, na.rm = T), paste0("n=", N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
systrait.prec.violin.plot <-
  systrait.biophys.data %>%
  # distinct SAF system trait types and precipitation
  distinct(`SAF System Trait type`, Prec) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(Prec > 0) %>%
  group_by(`SAF System Trait type`) %>%
  filter(n() >= 5) %>%
  ggplot(aes(y = Prec, x = reorder(`SAF System Trait type`, Prec))) +
  geom_violin(aes(fill = `SAF System Trait type`, alpha = 0.8)) +
  geom_jitter(
    height = 5, width = 0.1,
    size = 1.1, aes(col = `SAF System Trait type`, alpha = 1)
  ) +
  stat_summary(
    fun.data = "mean_sdl", fun.args = list(mult = 1),
    geom = "pointrange", color = "black"
  ) +
  theme_bw() +
  ylim(0, 1500) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of SAF system trait types across precipitation gradients",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "SAF system trait types",
    y = "Annual Precipitation [mm]"
  ) +
  coord_flip()


systrait.prec.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "systrait.prec.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## SAF system trait types - sand content

*Notice*: for SoilGrids variables there are several unique values per location, hence per study site. This is because SoilGrids data is predicted for five different soil depths.

**Violin plot; SAF system trait types - sand content**

```{r PLOTTING - system trait types in relation to sand, warning=FALSE, message=FALSE}
# number of observations per tree group
systrait.sand.data.N <- 
  systrait.biophys.data %>%
  # distinct SAF system trait types and sand
  distinct(`SAF System Trait type`, sandmean) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(sandmean > 0) %>%
  group_by(`SAF System Trait type`) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(`SAF System Trait type` == max(`SAF System Trait type`, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
systrait.sand.violin.plot <- 
systrait.biophys.data %>%
  # distinct SAF system trait types and sand
  distinct(`SAF System Trait type`, sandmean) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(sandmean > 0) %>%
  group_by(`SAF System Trait type`) %>% 
  filter(n() >= 5) %>%

  ggplot(aes(y = sandmean, x = reorder(`SAF System Trait type`, sandmean))) +
  geom_violin(aes(fill = `SAF System Trait type`, alpha = 0.8)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = `SAF System Trait type`, alpha = 1)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 100) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of SAF system trait types across soil sand content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "SAF system trait types",
       y = "Soil sand content [%]") +
  coord_flip()
  

systrait.sand.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "systrait.sand.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## SAF system trait types - clay content

*Notice*: for SoilGrids variables there are several unique values per location, hence per study site. This is because SoilGrids data is predicted for five different soil depths.

```{r PLOTTING - system trait types in relation to clay, warning=FALSE, message=FALSE}
# number of observations per tree group
systrait.clay.data.N <- 
  systrait.biophys.data %>%
  # distinct SAF system trait types and clay
  distinct(`SAF System Trait type`, claymean) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(claymean > 0) %>%
  group_by(`SAF System Trait type`) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(`SAF System Trait type` == max(`SAF System Trait type`, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
systrait.clay.violin.plot <- 
systrait.biophys.data %>%
  # distinct SAF system trait types and clay
  distinct(ID.S, `SAF System Trait type`, claymean) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(claymean > 0) %>%
  group_by(`SAF System Trait type`) %>% 
  filter(n() >= 5) %>%

  ggplot(aes(y = claymean, x = reorder(`SAF System Trait type`, claymean))) +
  geom_violin(aes(fill = `SAF System Trait type`, alpha = 0.8)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = `SAF System Trait type`, alpha = 1)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of SAF system trait types across soil clay content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "SAF system trait types",
       y = "Soil clay content [%]") +
  coord_flip()
  

systrait.clay.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "systrait.clay.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## SAF system trait types - SOC content

*Notice*: for SoilGrids variables there are several unique values per location, hence per study site. This is because SoilGrids data is predicted for five different soil depths.

```{r PLOTTING - system trait types in relation to soc, warning=FALSE, message=FALSE}
# number of observations per tree group
systrait.soc.data.N <- 
  systrait.biophys.data %>%
  # distinct SAF system trait types and soc
  distinct(`SAF System Trait type`, socmean) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(socmean > 0) %>%
  group_by(`SAF System Trait type`) %>% 
  mutate(N = n()) %>%
  mutate(N = ifelse(`SAF System Trait type` == max(`SAF System Trait type`, na.rm = T), paste0('n=', N), NA)) %>%
  filter(n() >= 5) %>%
  distinct(N)

# generating plot
systrait.soc.violin.plot <- 
systrait.biophys.data %>%
  # distinct SAF system trait types and soc
  distinct(`SAF System Trait type`, socmean) %>%
  filter(`SAF System Trait type` != "NA") %>%
  filter(socmean > 0) %>%
  group_by(`SAF System Trait type`) %>% 
  filter(n() >= 5) %>%

  ggplot(aes(y = socmean, x = reorder(`SAF System Trait type`, socmean))) +
  geom_violin(aes(fill = `SAF System Trait type`, alpha = 0.8)) +
  geom_jitter(height = 5, width = 0.1,
              size = 1.1, aes(col = `SAF System Trait type`, alpha = 1)) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    ) +
  theme_bw() +
  ylim(0, 50) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Distribution of SAF system trait types across soil soc content gradients",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0("Total number of independent studies = ", n_independent_studies),
       x = "SAF system trait types",
       y = "Soil soc content [%]") +
  coord_flip()
  

systrait.soc.violin.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "systrait.soc.violin.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Bar plots SAF trait types - temp + precip

**Bar plot; SAF system trait types - bioclim**

```{r}
# ---------------------------------------------------------------------------------------------------------------------
# Merging SAF system trait type plots in relation to bioclim variables#
# Making systrait.bioclim.data in long format
systrait.bioclim.data.long <-
  systrait.biophys.data %>%
  dplyr::select(-c(lat, lon)) %>%
  drop_na(Temp, Prec) %>%
  group_by(`SAF System Trait type`) %>%
  summarise(
    mean_temp = mean(Temp),
    mean_prec = mean(Prec)
  ) %>%
  pivot_longer(
    cols = -c(`SAF System Trait type`),
    names_to = "bioclim_variable",
    values_to = "value"
  )

# ----------------------------------------------------------------------------------------------------------- plot

systrait.bioclim.data.barplot <- systrait.bioclim.data.long %>%
  ggplot(aes(
    x = `SAF System Trait type`,
    y = value,
    fill = `SAF System Trait type`,
    alpha = 0.9
  )) +
  # geom_col() is replacement for geom_bar(stat = "identity")
  geom_col() +
  # independent x-axis scale in each facet,
  # drop absent factor levels (not the case here)
  facet_wrap(~bioclim_variable, scales = "free_y", drop = TRUE) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 75, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of SAF system trait types across mean bioclim variables",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "SAF system trait types",
    y = ""
  )

systrait.bioclim.data.barplot
```

## Bar plots SAF trait types - (sand + clay + bulk density + soc + ph)

**Bar plot; SAF system trait types - soil**

```{r}
# ---------------------------------------------------------------------------------------------------------------------
systrait.soil.data.long <-
  systrait.biophys.data %>%
  dplyr::select(-c(latitude, longitude)) %>%
  drop_na(sandmean, claymean, bdodmean, socmean, phh2omean) %>%
  group_by(`SAF System Trait type`) %>%
  summarise(
    mean_sand = mean(sandmean),
    mean_clay = mean(claymean),
    mean_bd = mean(bdodmean),
    mean_soc = mean(socmean),
    mean_ph = mean(phh2omean)
  ) %>%
  pivot_longer(
    cols = -c(`SAF System Trait type`),
    names_to = "soil_variable",
    values_to = "value"
  )
# --------------------------------------------------------------------------------------------------------------------- plot
systrait.soil.data.long %>%
  ggplot(aes(
    x = `SAF System Trait type`,
    y = value,
    fill = `SAF System Trait type`,
    alpha = 0.9
  )) +
  # geom_col() is replacement for geom_bar(stat = "identity")
  geom_col() +
  # independent x-axis scale in each facet,
  # drop absent factor levels (not the case here)
  facet_wrap(~soil_variable, scales = "free_y", drop = TRUE) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 75, hjust = 1), legend.position = "none") +
  scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Distribution of SAF system trait types across mean soil variables",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "SAF system trait types",
    y = ""
  )

```

## Interrow distance / spacing / width) - latitude

Creating the dataset for assessing **interrow distance as effect of latitude**

```{r}
interrow.data <-
  database.lat.lon %>%
  filter(CA.DIST.INTERROW != "NA" & latitude != "NA") %>%
  mutate_at("CA.DIST.INTERROW", as.numeric) %>%
  filter(CA.DIST.INTERROW <= 80) %>%
  relocate(CA.DIST.INTERROW, latitude)

# --------------------------------------------------------------- defining the linear function used in the plot
lm_eqn <- function(df) {
  m <- lm(latitude ~ CA.DIST.INTERROW, interrow.data)
  eq <- substitute(
    italic(y) == a + b %.% italic(x) * "," ~ ~ italic(r)^2 ~ "=" ~ r2,
    list(
      a = format(unname(coef(m)[1]), digits = 2),
      b = format(unname(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3)
    )
  )
  as.character(as.expression(eq))
}

```

**Line graph plot; relationship between interrow distance - latitute**

```{r}
lat.interrow.plot <-
  database.lat.lon %>%
  filter(CA.DIST.INTERROW != "NA" & latitude != "NA") %>%
  mutate_at("CA.DIST.INTERROW", as.numeric) %>%
  filter(CA.DIST.INTERROW <= 80) %>%
  ggplot(aes(
    x = CA.DIST.INTERROW,
    y = latitude
  )) +
  geom_jitter(aes(
    x = CA.DIST.INTERROW,
    y = latitude, colour = `SAF System Trait type`
  ),
  size = 0.4,
  alpha = 1,
  width = 3,
  height = 4
  ) +
  ggdensity::geom_hdr(xlim = c(0, 80), ylim = c(0, 60), alpha = 0.2) +
  geom_smooth(method = lm, se = FALSE, colour = "black") + # add linear trend line formula = y ~ splines::bs(x, 3)
  geom_text(x = 35, y = 65, label = lm_eqn(data), parse = TRUE, size = 3, col = "black") +
  labs(
    x = "Silvoarable system trait type",
    y = "n (records)"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none",
    plot.margin = margin(t = 10, r = 0, b = 10, l = 10, unit = "pt"),
    plot.title = element_text(vjust = 0)
  ) +
  scale_y_continuous(breaks = seq(30, 70, 10), limits = c(30, 70)) +
  labs( # title = "Latitude interrow distance",
    x = "Alley crop interrow distance [m]",
    y = "Latitude"
  )
# ggtitle("B")

lat.interrow.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "lat.interrow.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Global map of study (experimental sites) locations

Creating and plotting the **global map**

```{r}
world <- map_data("world") %>%
  filter(region != "Antarctica") # get the world map coordinates using map_data() function from the tidyverse suit of packages



world.study.sites <-
  ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "white", fill = "lightgray", size = 0.1
  ) +
  geom_point(
    data = database.lat.lon,
    aes(longitude, latitude, color = `SAF System Trait type`),
    alpha = 1, size = 0.2
  ) +
  geom_rect(
    aes(xmin = -15, xmax = 35, ymin = 35.5, ymax = 59),
    color = "black", fill = NA, inherit.aes = FALSE
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "top",
    plot.margin = margin(t = 0, r = 5, b = 0, l = 5, unit = "pt")
  ) +
  # scale_colour_discrete_qualitative(palette = "Dynamic", nmax = 8) +
  guides(color = guide_legend(override.aes = list(size = 1.5))) +
  coord_sf(ylim = c(20, 70), xlim = c(-140, 140)) +
  labs( # title = "Locations of study sites for peer-reviewed silvoarable agroforestry",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Longitude",
    y = "Latitude"
  )
# ggtitle("A")

world.study.sites
```

Creating map that is **zoomed on Europe** Now what if we wanted to use the *Mollweide projection* again as target projection

```{r}
# At first, we set the target CRS and transform the whole worldmap dataset to that CRS.
worldmap <- ne_countries(
  scale = "medium", type = "map_units",
  returnclass = "sf"
)
target_crs <- "+proj=moll"
worldmap_trans <- st_transform(worldmap, crs = target_crs)

# Next, we specify the display window in WGS84 coordinates as longitude / latitude degrees.

disp_win_wgs84 <- st_sfc(st_point(c(-20, 30)), st_point(c(45, 73)),
  crs = 4326
)

# These coordinates can be transformed to our target CRS via st_transform.

disp_win_trans <- st_transform(disp_win_wgs84, crs = target_crs)

# We can extract the coordinates from these points and pass them as limits for the x and y scale respectively. Note also that I set datum = target_crs which makes sure that the graticule is displayed in the target CRS. Otherwise ggplot2 by default displays a WGS84 graticule.

disp_win_coord <- st_coordinates(disp_win_trans)

ggplot() +
  geom_sf(data = worldmap_trans) +
  coord_sf(
    xlim = disp_win_coord[, "X"], ylim = disp_win_coord[, "Y"],
    datum = target_crs, expand = FALSE
  ) +
  theme_bw()
```

**Calculate the display window for given a center point and zoom level**

Instead of specifying a rectangular region of interest, I found it more comfortable to set a center point of interest and specify a "zoom level" which specifies how much area around this spot should be displayed.

I oriented myself on how zoom levels are defined for OpenStreetMap: A level of zero shows the whole world. A level of 1 shows a quarter of the world map. A level of two shows 1/16th of the world map and so on. This goes up to a zoom level of 19. So if z is the zoom level, we see a region that covers 1/4\^z of the world. This means the range on the longitude axis that is displayed is 360Â°/2\^z (because the longitude spans the full horizontal circle around the world from -180Â° to +180Â°) and the range on the latitude axis is 180Â°/2\^z (latitude spans the half vertical circle from -90Â° to +90Â°).

Let's set a center point zoom_to, a zoom_level and calculate the ranges for longitude and latitude (lon_span and lat_span).

```{r}
# Europe
zoom_to.eu <- c(13.38, 52.52)  # Berlin (from OpenStreetMap)

# North America
zoom_to.na <- c( -94.58, 39.06)  # Kansas (from OpenStreetMap)

zoom_level <- 2


lon_span <- 360 / 2^zoom_level
lat_span <- 180 / 2^zoom_level
```

**Calculate the longitude and latitude ranges for the the display window**

Now we can calculate the longitude and latitude ranges for the the display window by subtracting/adding the half of the above ranges from/to the zoom center coordinates respectively.

```{r}
# Europe
lon_bounds.eu <- c(zoom_to.eu[1] - lon_span / 2, zoom_to.eu[1] + lon_span / 2)
lat_bounds.eu <- c(zoom_to.eu[2] - lat_span / 2, zoom_to.eu[2] + lat_span / 2)

# North America
lon_bounds.na <- c(zoom_to.na[1] - lon_span / 2, zoom_to.na[1] + lon_span / 2)
lat_bounds.na <- c(zoom_to.na[2] - lat_span / 2, zoom_to.na[2] + lat_span / 2)
```

**Plotting the map; Europe map**

```{r}
# We can now plot the map with the specified display window for zoom level 2, highlighting the zoom center for Europe

map.europe <-
  ggplot() +
  geom_sf(data = worldmap) +
  geom_sf(
    data = st_sfc(st_point(zoom_to.eu), crs = 4326),
    color = "blue", alpha = 0
  ) +
  coord_sf(xlim = lon_bounds.eu, ylim = lat_bounds.eu) +
  theme_bw() +
  geom_point(
    data = database.lat.lon,
    aes(longitude, latitude, color = `SAF System Trait type`),
    alpha = 1, size = 0.5
  ) +
  scale_x_continuous(label = abs) +
  scale_y_continuous(label = abs) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none",
    plot.margin = margin(t = 0, r = 58, b = 0, l = 0, unit = "pt")
  ) +
  # scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs( # title = "Locations of study sites for peer-reviewed silvoarable agroforestry",
    # subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    # caption = paste0("Total number of independent studies = ", n_independent_studies),
    x = "Longitude",
    y = "Latitude"
  )
# labs(title = "Locations of study sites in Europe")

map.europe
```

**Creating and plotting; North America map**

```{r}
# We can now plot the map with the specified display window for zoom level 2, highlighting the zoom center for North America

map.northamerica <-
  ggplot() +
  geom_sf(data = worldmap) +
  geom_sf(
    data = st_sfc(st_point(zoom_to.na), crs = 4326),
    color = "blue", alpha = 0
  ) +
  coord_sf(xlim = lon_bounds.na, ylim = lat_bounds.na) +
  theme_bw() +
  geom_point(
    data = database.lat.lon,
    aes(longitude, latitude, color = `SAF System Trait type`),
    alpha = 1, size = 0.5
  ) +
  scale_x_continuous(label = abs) +
  scale_y_continuous(label = abs) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1), legend.position = "none") +
  # scale_colour_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Locations of study sites in North America")

map.northamerica
```

**Combining the three maps (global, Europe and interrow distance as effect of latitude)**

```{r}
# Arrange plots using arrangeGrob and using gridExtra and cowplot
# returns a gtable (gt)
gt <- arrangeGrob(world.study.sites, # bar plot spaning two columns
  map.europe, lat.interrow.plot, # box plot and scatter plot
  ncol = 2, nrow = 2,
  layout_matrix = rbind(c(1, 1), c(2, 3))
)

# Add labels to the arranged plots
combined.geolocation.linterrow.lat <- as_ggplot(gt) + # transform to a ggplot
  draw_plot_label(
    label = c("A", "B", "C"), size = 15,
    x = c(0, 0, 0.5), y = c(1, 0.5, 0.5)
  ) # Add labels

combined.geolocation.linterrow.lat
```

*Saving last plot*

```{r}
ggsave(
  filename = "combined.geolocation.linterrow.lat.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

# Geospatial data; multivariate data (matrices)

## Ecosystem services (including biodiversity + categories) - biophysical variables

To answer the question; **does SAF, ES research focus differ as related to location-specific biophysical variables**

Various biophysical variables are **discretised** (from numeric biophys into categorical groups). Adding grouped intervals based on continuous soil variables. This is in order to visualise them in relation to ES for instance.

**Loading and preparing dataset** The dataset is including only *selected ecosystem services*

To form the selected ecosystem services we use information from the *data dimensions*; **ecosystem services**, **biodiversity** and **categories of approach**, following the style of *Ditzler et al. (2021)*, *Duru et al. (2015)* and *Tamburini et al. (2020)*

```{r Loading dataset with lat long coordinates}
biophys.discretised.data <- vroom::vroom("./DATASET.FROM.SCRIPT/biophys.discretised.data.csv") %>%
  dplyr::select(
    "SAF System Trait type",
    "ID.P",
    "ID.S",
    "lat", 
    "lon",
# ----------------------------------------------------------------------------------------------------------
# These selected ecosystem services (below) are based on the *data dimensions*; **ecosystem services**, **biodiversity** and **categories of approach**. Following the style of *Ditzler et al. (2021)*, *Duru et al. (2015)* and *Tamburini et al. (2020)* 

    "Food (yield)",
    "Feed",
    "Fuel (firewood etc.)",
    "Biodiversity",
    "Disease regulation",
    "Pest regulation",
    "Water cycling",
    "Economic management related",
    "Economic profit related",
    "Aboveground (crop-tree) light competition",
    "Soil structure", 
    "Chemical soil components",
    "Biological soil components",
    "Land equivalent ratio",
    "Climate regulation",
    "Greenhouse gas emissions",
    "Carbon sequestration",

# --------------------------------------------------------------------------------------- biophysical (soil, bioclim) variables
    "Temp", "Temp_interval", 
    "Prec", "Prec_interval",
    "claymean", "clay_interval",
    "sandmean", "sand_interval",
    "siltmean", "silt_interval",
    "bdodmean", "bd_interval",
    "nitrogenmean", "nitrogen_interval",
    "socmean", "soc_interval",
    "phh2omean", "ph_interval",
    "cecmean", "cec_interval") 
```

## Ecosystem services (selected ecosystem services) - soil sand content

**Loading dataset**

```{r }

es.systrait.sand.data <- vroom::vroom("./DATASET.FROM.SCRIPT/es.systrait.sand.data.csv") 
```

**Matrix; selected ES (including biodiversity and categories data) with sand intervals**

```{r PLOTTING - selected ES (including biodiversity and categories data) with sand intervals, warning=FALSE, message=FALSE}
es.systrait.sand.plot <- es.systrait.sand.data %>%
  group_by(ES.GROUPS, sand_interval, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  ggplot(aes(
    x = reorder(`SAF System Trait type`, -count),
    y = reorder(ES.GROUPS, -count),
    fill = sand_interval
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  scale_size_continuous(range = c(1, 10)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the frequency of associations of studied ecosystem services for different SAF systems across soil sand concentration intervals 
reported by peer-reviewed papers",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    x = "Silvoarable System Trait Types",
    y = "Selected ecosystem services"
  ) +
  facet_grid(. ~ sand_interval)

es.systrait.sand.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "es.systrait.sand.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services (selected ecosystem services) - soil organic carbon (SOC content)

**Loading dataset**

```{r }

es.systrait.soc.data <- vroom::vroom("./DATASET.FROM.SCRIPT/es.systrait.soc.data.csv") 
```

**Matrix; selected ES (including biodiversity and categories data) with SOC intervals**

```{r PLOTTING - selected ES (including biodiversity and categories data) with SOC intervals, warning=FALSE, message=FALSE}
es.systrait.soc.plot <- es.systrait.soc.data %>%
  group_by(ES.GROUPS, soc_interval, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  ggplot(aes(
    x = reorder(`SAF System Trait type`, -count),
    y = reorder(ES.GROUPS, -count),
    fill = soc_interval
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  scale_size_continuous(range = c(1, 10)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the frequency of associations of studied ecosystem services for different SAF systems across SOC content intervals 
reported by peer-reviewed papers",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    x = "Silvoarable System Trait Types",
    y = "Selected ecosystem services"
  ) +
  facet_grid(. ~ factor(soc_interval,
                        levels = c("0 - 50 g/kg", "50 - 100 g/kg", "100 - 150 g/kg", "150 - 200 g/kg", "200 - 250 g/kg", "250 - 300 g/kg")))

es.systrait.soc.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "es.systrait.soc.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services (selected ecosystem services) - temperature

**Loading dataset**

```{r }

es.systrait.temp.data <- vroom::vroom("./DATASET.FROM.SCRIPT/es.systrait.temp.data.csv") 
```

**Matrix; selected ES (including biodiversity and categories data) with temperature intervals**

```{r PLOTTING - selected ES (including biodiversity and categories data) with temperature intervals, warning=FALSE, message=FALSE}
es.systrait.temp.plot <- es.systrait.temp.data %>%
  group_by(ES.GROUPS, Temp_interval, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%
  ggplot(aes(
    x = reorder(`SAF System Trait type`, -count),
    y = reorder(ES.GROUPS, -count),
    fill = Temp_interval
  )) +
  geom_jitter(aes(size = count),
    shape = 21, colour = "black",
    alpha = 0.8,
    height = 0.1,
    width = 0.1
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  scale_size_continuous(range = c(1, 10)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(
    title = "Matrix showing the frequency of associations of studied ecosystem services for different SAF systems across mean annual temperature intervals 
reported by peer-reviewed papers",
    subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
    caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
    x = "Silvoarable System Trait Types",
    y = "Selected ecosystem services"
  ) +
  facet_grid(. ~ factor(Temp_interval,
    levels = c("-10 - -5 [Â°C]", "-5 - 0 [Â°C]", "0 - 5 [Â°C]", "5 - 10 [Â°C]", "10 - 15 [Â°C]", "15 - 20 [Â°C]")
  ))

es.systrait.temp.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "es.systrait.temp.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```

## Ecosystem services (selected ecosystem services) - precipitation

**Loading dataset**

```{r }

es.systrait.prec.data <- vroom::vroom("./DATASET.FROM.SCRIPT/es.systrait.prec.data.csv") 
```

**Matrix; selected ES (including biodiversity and categories data) with precipitation intervals**

```{r PLOTTING - selected ES (including biodiversity and categories data) with precipitation intervals, warning=FALSE, message=FALSE}
es.systrait.prec.plot <- es.systrait.prec.data %>%
  group_by(ES.GROUPS, Prec_interval, `SAF System Trait type`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate_if(is.integer, as.double) %>%
  mutate_if(is.character, as.factor) %>%

  ggplot(aes(x = reorder(`SAF System Trait type`, -count), 
             y = reorder(ES.GROUPS, -count),
             fill = Prec_interval)) +
  geom_jitter(aes(size = count), shape = 21, colour = "black",
             alpha = 0.8,
             height = 0.1,
             width = 0.1) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  scale_size_continuous(range = c(1, 10)) +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  labs(title = "Matrix showing the frequency of associations of studied ecosystem services for different SAF systems across annual precipitation intervals 
reported by peer-reviewed papers",
       subtitle = paste("n (individual study sites) = ", n_individual_study_sites),
       caption = paste0(caption = paste0("* Line belts; shelterbelts, hedgerows and windbreaks. Total number of independent studies reporting on ES = ", total_n_ES$value)),
       x = "Silvoarable System Trait Types",                       
       y = "Selected ecosystem services") +
  facet_grid(. ~factor(Prec_interval, 
                       levels = c("0 - 300 [mm]", "300 - 600 [mm]", "600 - 900 [mm]", "900 - 1200 [mm]", "1200 - 1500 [mm]", "1500 - 1800 [mm]"))) 
  
es.systrait.prec.plot
```

*Saving last plot*

```{r}
ggsave(
  filename = "es.systrait.prec.plot.png",
  plot = last_plot(),
  path = "./FIGURES.OUTPUT.FROM.SCRIPT",
  width = 35, 
  height = 15, 
  units = "cm",
  dpi = 500
)
```
